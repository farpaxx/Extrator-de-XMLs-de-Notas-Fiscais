<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de XMLs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .dashboard {
            margin-top: 30px;
        }
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
        table {
            margin-top: 20px;
        }
    </style>
    <!-- Adicione este script no <head> para garantir que Chart.js seja carregado -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Extrator de XMLs de Notas Fiscais</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                Carregar Arquivos
            </div>
            <div class="card-body">
                <input type="file" id="xmlFile" accept=".xml" multiple class="form-control mb-3">
                <button onclick="extractData()" class="btn btn-primary">Extrair Dados</button>
                <div id="progressArea" class="mt-3 d-none">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="progressStatus" class="mt-2"></p>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <h2>Dashboard</h2>
            
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="resumo-tab" data-bs-toggle="tab" data-bs-target="#resumo" type="button" role="tab">Resumo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="destinatarios-tab" data-bs-toggle="tab" data-bs-target="#destinatarios" type="button" role="tab">Por Destinatário</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tipos-tab" data-bs-toggle="tab" data-bs-target="#tipos" type="button" role="tab">Por Tipo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fiscal-tab" data-bs-toggle="tab" data-bs-target="#fiscal" type="button" role="tab">Análise Fiscal</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados" type="button" role="tab">Dados Completos</button>
                </li>
            </ul>
            
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="resumo" role="tabpanel">
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Total por Tipo de Nota</div>
                                <div class="card-body">
                                    <div id="tipoChart" class="chart-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">Total por Destinatário (Top 5)</div>
                                <div class="card-body">
                                    <div id="destinatarioChart" class="chart-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header">Estatísticas Gerais</div>
                        <div class="card-body">
                            <div id="estatisticas"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="destinatarios" role="tabpanel">
                    <div class="mt-4">
                        <div id="tabelaDestinatarios"></div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="tipos" role="tabpanel">
                    <div class="mt-4">
                        <div id="tabelaTipos"></div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="fiscal" role="tabpanel">
                    <div class="mt-4">
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        Resumo de Impostos por Emitente
                                        <div class="float-end">
                                            <select id="seletorEmitenteImposto" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                                <option value="todos">Todos os Emitentes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="resumoImpostosEmitente"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">Total de Impostos por Tipo</div>
                                    <div class="card-body">
                                        <canvas id="impostosPorTipoChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">Análise de CFOPs</div>
                                    <div class="card-body">
                                        <canvas id="cfopChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                Análise Detalhada de Impostos
                                <div class="float-end">
                                    <select id="filtroTipoImpostoDetalhado" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                        <option value="todos">Todos os Impostos</option>
                                        <option value="ICMS">ICMS</option>
                                        <option value="IPI">IPI</option>
                                        <option value="PIS">PIS</option>
                                        <option value="COFINS">COFINS</option>
                                        <option value="ISS">ISS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm" id="tabelaImpostosDetalhados">
                                        <thead>
                                            <tr>
                                                <th>Nota</th>
                                                <th>Emitente</th>
                                                <th>Data</th>
                                                <th>Tipo Imposto</th>
                                                <th>Base de Cálculo</th>
                                                <th>Alíquota</th>
                                                <th>Valor</th>
                                                <th>CST/CSOSN</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dadosImpostosDetalhados"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">Verificação de Conformidade</div>
                            <div class="card-body">
                                <div id="alertasConformidade"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="dados" role="tabpanel">
                    <div class="mt-4">
                        <input type="text" id="filtroTabela" class="form-control mb-3" placeholder="Filtrar dados...">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabelaDados">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Valor</th>
                                        <th>Emitente</th>
                                        <th>Destinatário</th>
                                        <th>CNPJ/CPF Dest.</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="dadosTabela"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal fade" id="detalheModal" tabindex="-1" aria-labelledby="detalheModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detalheModalLabel">Detalhes da Nota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detalheConteudo"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Duplicados -->
    <div class="modal fade" id="duplicadosModal" tabindex="-1" aria-labelledby="duplicadosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="duplicadosModalLabel">Notas Fiscais Duplicadas Encontradas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O sistema encontrou notas fiscais que já existem no banco de dados. Selecione o que deseja fazer com cada uma:</p>
                    <div class="mb-3">
                        <button id="selecionarTodos" class="btn btn-sm btn-outline-primary">Selecionar Todos</button>
                        <button id="desmarcarTodos" class="btn btn-sm btn-outline-secondary">Desmarcar Todos</button>
                    </div>
                    <div id="listaDuplicados" class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Substituir</th>
                                    <th>Nota</th>
                                    <th>Tipo</th>
                                    <th>Emitente</th>
                                    <th>Destinatário</th>
                                    <th>Valor</th>
                                    <th>Arquivo</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDuplicados"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarImportacao">Confirmar Importação</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Erros de Importação -->
    <div class="modal fade" id="errosImportacaoModal" tabindex="-1" aria-labelledby="errosImportacaoModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errosImportacaoModalLabel">Erros na Importação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Ocorreram erros durante a importação dos seguintes arquivos:</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Arquivo</th>
                                    <th>Erro</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaErrosImportacao"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado do Filtro -->
    <div class="modal fade" id="resultadoFiltroModal" tabindex="-1" aria-labelledby="resultadoFiltroModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultadoFiltroModalLabel">Resultado do Filtro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="mensagemResultadoFiltro">Filtro aplicado: <b>0</b> notas encontradas.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body> 
<script>
    // Inicializar o banco de dados
    let db;
    const dbName = "NotasFiscaisDB";
    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains("notas")) {
            const store = db.createObjectStore("notas", { keyPath: "id", autoIncrement: true });
            store.createIndex("numero", "numero", { unique: false });
            store.createIndex("tipo", "tipo", { unique: false });
            store.createIndex("data", "data", { unique: false });
            store.createIndex("destinatario", "destinatario.nome", { unique: false });
            store.createIndex("destinatarioCNPJ", "destinatario.cnpj", { unique: false });
        }
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        atualizarDashboard();
    };

    request.onerror = function(event) {
        console.error("Erro ao abrir o banco de dados:", event.target.error);
        alert("Erro ao acessar o banco de dados: " + event.target.error);
    };

    // Extrair dados de arquivos XML
    function extractData() {
        const fileInput = document.getElementById('xmlFile');
        const files = fileInput.files;
        
        if (files.length === 0) {
            alert("Por favor, selecione pelo menos um arquivo XML.");
            return;
        }

        // Mostrar área de progresso
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const progressStatus = document.getElementById('progressStatus');
        progressArea.classList.remove('d-none');
        progressBar.style.width = '0%';
        progressStatus.textContent = `Processando 0 de ${files.length} arquivos...`;

        // Primeiro vamos verificar duplicações
        verificarDuplicados(files);
    }

    // Função para verificar notas duplicadas
    function verificarDuplicados(files) {
        const dadosExtraidos = [];
        let totalProcessados = 0;
        const duplicados = [];
        const erros = []; // Array para armazenar arquivos com erro
        
        // Primeiro extrair os dados de todos os arquivos
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                    
                    // Verificar se o XML é válido (não contém erros de parser)
                    const parserError = xmlDoc.getElementsByTagName("parsererror");
                    if (parserError.length > 0) {
                        throw new Error("XML inválido ou mal formatado");
                    }
                    
                    // Detectar o tipo de documento (NFe, CTe, etc.)
                    let tipoDoc = "Desconhecido";
                    let dados = null;
                    
                    if (xmlDoc.getElementsByTagName("NFe").length > 0) {
                        tipoDoc = "NFe";
                        dados = extrairDadosNFe(xmlDoc);
                    } else if (xmlDoc.getElementsByTagName("CTe").length > 0) {
                        tipoDoc = "CTe";
                        dados = extrairDadosCTe(xmlDoc);
                    } else if (xmlDoc.getElementsByTagName("NFS-e").length > 0 || 
                              xmlDoc.getElementsByTagName("NFS").length > 0 || 
                              xmlDoc.getElementsByTagName("Nfse").length > 0 || 
                              xmlDoc.getElementsByTagName("CompNfse").length > 0 ||
                              xmlDoc.getElementsByTagName("nfse").length > 0) {
                        tipoDoc = "NFS-e";
                        dados = extrairDadosNFSe(xmlDoc);
                    } else {
                        // Tentar determinar o tipo pelo conteúdo
                        const conteudoXml = xmlDoc.documentElement.outerHTML.toLowerCase();
                        if (conteudoXml.includes("nfse") || conteudoXml.includes("nfs-e")) {
                            tipoDoc = "NFS-e";
                            dados = extrairDadosNFSe(xmlDoc);
                        } else if (conteudoXml.includes("nfe")) {
                            tipoDoc = "NFe";
                            dados = extrairDadosNFe(xmlDoc);
                        } else if (conteudoXml.includes("cte")) {
                            tipoDoc = "CTe";
                            dados = extrairDadosCTe(xmlDoc);
                        } else {
                            throw new Error("Tipo de documento fiscal não reconhecido");
                        }
                    }
                    
                    if (!dados) {
                        throw new Error(`Falha ao extrair dados do documento ${tipoDoc}`);
                    }
                    
                    // Guardar nome do arquivo original
                    dados.nomeArquivo = file.name;
                    dadosExtraidos.push(dados);
                } catch (error) {
                    console.error(`Erro ao processar arquivo ${file.name}:`, error);
                    erros.push({
                        arquivo: file.name,
                        erro: error.message || "Erro desconhecido na importação"
                    });
                }
                
                totalProcessados++;
                const porcentagem = Math.round((totalProcessados / files.length) * 50); // 50% para extração
                progressBar.style.width = porcentagem + '%';
                progressStatus.textContent = `Analisando ${totalProcessados} de ${files.length} arquivos...`;
                
                // Quando terminar a extração, verificar duplicações
                if (totalProcessados === files.length) {
                    if (erros.length > 0) {
                        // Mostrar erros antes de prosseguir
                        mostrarErrosImportacao(erros);
                    }
                    
                    if (dadosExtraidos.length > 0) {
                        // Uma nova transação para verificar duplicados
                        verificarNoExistentes(dadosExtraidos);
                    } else {
                        progressStatus.textContent = `Nenhum arquivo válido foi importado. Verifique os erros.`;
                    }
                }
            };
            
            reader.onerror = function() {
                console.error("Erro ao ler o arquivo:", file.name);
                erros.push({
                    arquivo: file.name,
                    erro: "Falha na leitura do arquivo"
                });
                totalProcessados++;
            };
            
            reader.readAsText(file);
        }
        
        // Função para verificar notas existentes no banco
        function verificarNoExistentes(dadosExtraidos) {
            const transaction = db.transaction(["notas"], "readonly");
            const store = transaction.objectStore("notas");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const notasExistentes = event.target.result;
                
                // Verificar duplicações
                for (const novaData of dadosExtraidos) {
                    const duplicada = notasExistentes.find(notaExistente => 
                        notaExistente.numero === novaData.numero && 
                        notaExistente.tipo === novaData.tipo);
                    
                    if (duplicada) {
                        duplicados.push({
                            nova: novaData,
                            existente: duplicada
                        });
                    }
                }
                
                progressStatus.textContent = `Verificação concluída. Encontradas ${duplicados.length} notas duplicadas.`;
                
                if (duplicados.length > 0) {
                    // Mostrar modal de duplicados
                    mostrarModalDuplicados(duplicados, dadosExtraidos);
                } else {
                    // Se não há duplicados, processar normalmente
                    processarNotas(dadosExtraidos, []);
                }
            };
            
            request.onerror = function(event) {
                console.error("Erro ao recuperar dados para verificação:", event.target.error);
                // Continuar mesmo com o erro
                processarNotas(dadosExtraidos, []);
            };
        }
    }

    // Mostrar modal com notas duplicadas
    function mostrarModalDuplicados(duplicados, todasNotas) {
        // Preencher a tabela com as notas duplicadas
        const tbody = document.getElementById('tabelaDuplicados');
        tbody.innerHTML = '';
        
        duplicados.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="form-check-input substituir-check" data-index="${index}">
                </td>
                <td>${item.nova.numero}</td>
                <td>${item.nova.tipo}</td>
                <td>${item.nova.emitente.nome}</td>
                <td>${item.nova.destinatario.nome}</td>
                <td>R$ ${item.nova.valor.toFixed(2)}</td>
                <td>${item.nova.nomeArquivo}</td>
            `;
            tbody.appendChild(tr);
        });
        
        // Botões para selecionar/desmarcar todos
        document.getElementById('selecionarTodos').onclick = function() {
            const checkboxes = document.querySelectorAll('.substituir-check');
            checkboxes.forEach(cb => cb.checked = true);
        };
        
        document.getElementById('desmarcarTodos').onclick = function() {
            const checkboxes = document.querySelectorAll('.substituir-check');
            checkboxes.forEach(cb => cb.checked = false);
        };
        
        // Botão confirmar
        document.getElementById('confirmarImportacao').onclick = function() {
            const substituir = [];
            const checkboxes = document.querySelectorAll('.substituir-check');
            
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (cb.checked) {
                    substituir.push(duplicados[index].nova);
                }
            });
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('duplicadosModal'));
            modal.hide();
            
            // Filtrar notas duplicadas conforme seleção do usuário
            const notasParaImportar = todasNotas.filter(nota => {
                // Se não for duplicada, importa normalmente
                const duplicada = duplicados.find(d => 
                    d.nova.numero === nota.numero && 
                    d.nova.tipo === nota.tipo && 
                    d.nova.nomeArquivo === nota.nomeArquivo);
                
                if (!duplicada) return true;
                
                // Se for duplicada, verifica se foi selecionada para substituir
                return substituir.some(s => 
                    s.numero === nota.numero && 
                    s.tipo === nota.tipo && 
                    s.nomeArquivo === nota.nomeArquivo);
            });
            
            // Processar as notas (tanto novas quanto as que o usuário escolheu substituir)
            processarNotas(notasParaImportar, substituir);
        };
        
        // Exibir modal
        const duplicadosModal = new bootstrap.Modal(document.getElementById('duplicadosModal'));
        duplicadosModal.show();
    }

    // Processar notas após decidir sobre duplicações
    function processarNotas(notas, substituir) {
        const progressBar = document.getElementById('progressBar');
        const progressStatus = document.getElementById('progressStatus');
        
        if (notas.length === 0) {
            progressStatus.textContent = `Nenhuma nota selecionada para importação.`;
            return;
        }
        
        let processados = 0;
        let sucessos = 0;
        
        progressStatus.textContent = `Importando notas fiscais...`;
        progressBar.style.width = '50%'; // Começar da metade
        
        // Se tiver substituições, excluir as notas antigas primeiro
        excluirDuplicadasEAdicionar();
        
        function excluirDuplicadasEAdicionar() {
            if (substituir.length > 0) {
                const transaction = db.transaction(["notas"], "readwrite");
                const store = transaction.objectStore("notas");
                
                // Para cada nota a substituir, buscar e excluir a existente
                substituir.forEach(novaNota => {
                    const indexNumero = store.index("numero");
                    const singleKeyRange = IDBKeyRange.only(novaNota.numero);
                    
                    indexNumero.openCursor(singleKeyRange).onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            const notaExistente = cursor.value;
                            // Verificar se é a mesma nota pelo tipo
                            if (notaExistente.tipo === novaNota.tipo) {
                                store.delete(cursor.primaryKey);
                            }
                            cursor.continue();
                        }
                    };
                });
                
                transaction.oncomplete = function() {
                    adicionarNovasNotas();
                };
                
                transaction.onerror = function(event) {
                    console.error("Erro ao excluir notas existentes:", event.target.error);
                    adicionarNovasNotas(); // Continuar mesmo com erro
                };
            } else {
                adicionarNovasNotas();
            }
        }
        
        function adicionarNovasNotas() {
            const transaction = db.transaction(["notas"], "readwrite");
            const store = transaction.objectStore("notas");
            
            notas.forEach(nota => {
                const request = store.add(nota);
                
                request.onsuccess = function() {
                    sucessos++;
                    processados++;
                    atualizarProgressoImportacao();
                };
                
                request.onerror = function(event) {
                    console.error("Erro ao salvar nota:", event.target.error);
                    processados++;
                    atualizarProgressoImportacao();
                };
            });
            
            transaction.oncomplete = function() {
                console.log("Todas as notas foram processadas com sucesso!");
            };
        }
        
        function atualizarProgressoImportacao() {
            // Calcular progresso: 50% já era da extração, então vamos de 50% a 100%
            const porcentagem = 50 + Math.round((processados / notas.length) * 50);
            progressBar.style.width = porcentagem + '%';
            progressStatus.textContent = `Importando ${processados} de ${notas.length} notas...`;
            
            if (processados === notas.length) {
                progressStatus.textContent = `Concluído! ${sucessos} de ${notas.length} notas importadas com sucesso.`;
                setTimeout(() => {
                    atualizarDashboard();
                }, 500);
            }
        }
    }

    // Função para mostrar erros de importação em um modal
    function mostrarErrosImportacao(erros) {
        // Criar modal de erros se não existir
        if (!document.getElementById('errosImportacaoModal')) {
            const modalHTML = `
            <div class="modal fade" id="errosImportacaoModal" tabindex="-1" aria-labelledby="errosImportacaoModalLabel">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="errosImportacaoModalLabel">Erros na Importação</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Ocorreram erros durante a importação dos seguintes arquivos:</p>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Arquivo</th>
                                            <th>Erro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaErrosImportacao"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            const div = document.createElement('div');
            div.innerHTML = modalHTML;
            document.body.appendChild(div);
        }
        
        // Preencher a tabela de erros
        const tbody = document.getElementById('tabelaErrosImportacao');
        tbody.innerHTML = '';
        
        erros.forEach(erro => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${erro.arquivo}</td>
                <td>${erro.erro}</td>
            `;
            tbody.appendChild(tr);
        });
        
        // Mostrar o modal
        const modal = new bootstrap.Modal(document.getElementById('errosImportacaoModal'));
        modal.show();
    }

    // Extrair dados de NFe
    function extrairDadosNFe(xmlDoc) {
        try {
            const inf = xmlDoc.getElementsByTagName("infNFe")[0];
            const ide = inf.getElementsByTagName("ide")[0];
            const emit = inf.getElementsByTagName("emit")[0];
            const dest = inf.getElementsByTagName("dest")[0];
            const total = inf.getElementsByTagName("total")[0];
            const items = inf.getElementsByTagName("det");
            
            const numeroNF = getElementText(ide, "nNF");
            const data = formatarData(getElementText(ide, "dhEmi"));
            const valorTotal = parseFloat(getElementText(total.getElementsByTagName("ICMSTot")[0], "vNF"));
            
            // Extrair CFOP principal
            let cfopPrincipal = getElementText(ide, "CFOP") || getElementText(ide, "natOp") || "";
            
            // Informações do emitente
            const emitente = {
                nome: getElementText(emit, "xNome"),
                cnpj: getElementText(emit, "CNPJ") || getElementText(emit, "CPF"),
                ie: getElementText(emit, "IE") || "",
                endereco: {
                    logradouro: getElementText(emit.getElementsByTagName("enderEmit")[0], "xLgr") || "",
                    numero: getElementText(emit.getElementsByTagName("enderEmit")[0], "nro") || "",
                    bairro: getElementText(emit.getElementsByTagName("enderEmit")[0], "xBairro") || "",
                    municipio: getElementText(emit.getElementsByTagName("enderEmit")[0], "xMun") || "",
                    uf: getElementText(emit.getElementsByTagName("enderEmit")[0], "UF") || "",
                    cep: getElementText(emit.getElementsByTagName("enderEmit")[0], "CEP") || ""
                }
            };
            
            // Informações do destinatário
            const destinatario = {
                nome: getElementText(dest, "xNome"),
                cnpj: getElementText(dest, "CNPJ") || getElementText(dest, "CPF"),
                ie: getElementText(dest, "IE") || "",
                endereco: {
                    logradouro: getElementText(dest.getElementsByTagName("enderDest")[0], "xLgr") || "",
                    numero: getElementText(dest.getElementsByTagName("enderDest")[0], "nro") || "",
                    bairro: getElementText(dest.getElementsByTagName("enderDest")[0], "xBairro") || "",
                    municipio: getElementText(dest.getElementsByTagName("enderDest")[0], "xMun") || "",
                    uf: getElementText(dest.getElementsByTagName("enderDest")[0], "UF") || "",
                    cep: getElementText(dest.getElementsByTagName("enderDest")[0], "CEP") || ""
                }
            };
            
            // Extrair informações de impostos totais
            const icmsTot = total.getElementsByTagName("ICMSTot")[0];
            const impostosTotais = {
                baseCalculoICMS: parseFloat(getElementText(icmsTot, "vBC") || "0"),
                valorICMS: parseFloat(getElementText(icmsTot, "vICMS") || "0"),
                baseCalculoICMSST: parseFloat(getElementText(icmsTot, "vBCST") || "0"),
                valorICMSST: parseFloat(getElementText(icmsTot, "vST") || "0"),
                valorProdutos: parseFloat(getElementText(icmsTot, "vProd") || "0"),
                valorFrete: parseFloat(getElementText(icmsTot, "vFrete") || "0"),
                valorSeguro: parseFloat(getElementText(icmsTot, "vSeg") || "0"),
                valorDesconto: parseFloat(getElementText(icmsTot, "vDesc") || "0"),
                valorIPI: parseFloat(getElementText(icmsTot, "vIPI") || "0"),
                valorPIS: parseFloat(getElementText(icmsTot, "vPIS") || "0"),
                valorCOFINS: parseFloat(getElementText(icmsTot, "vCOFINS") || "0"),
                valorOutrasDespesas: parseFloat(getElementText(icmsTot, "vOutro") || "0"),
                valorTotalNota: parseFloat(getElementText(icmsTot, "vNF") || "0")
            };
            
            // Extrair itens com detalhes de impostos
            const produtos = [];
            const impostosPorItem = [];
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const prod = item.getElementsByTagName("prod")[0];
                const imposto = item.getElementsByTagName("imposto")[0];
                
                // CFOP do item (pode ser diferente do principal)
                const cfopItem = getElementText(prod, "CFOP") || "";
                
                // Extrair dados do produto
                const produto = {
                    codigo: getElementText(prod, "cProd"),
                    descricao: getElementText(prod, "xProd"),
                    ncm: getElementText(prod, "NCM") || "",
                    cfop: cfopItem,
                    quantidade: parseFloat(getElementText(prod, "qCom")),
                    valorUnitario: parseFloat(getElementText(prod, "vUnCom")),
                    valorTotal: parseFloat(getElementText(prod, "vProd"))
                };
                
                produtos.push(produto);
                
                // Extrair impostos do item
                if (imposto) {
                    // ICMS
                    const icms = imposto.getElementsByTagName("ICMS")[0];
                    if (icms) {
                        // Buscar o grupo específico de ICMS (ICMS00, ICMS10, etc.)
                        const icmsGroups = ["ICMS00", "ICMS10", "ICMS20", "ICMS30", "ICMS40", "ICMS51", "ICMS60", "ICMS70", "ICMS90", "ICMSSN101", "ICMSSN102", "ICMSSN201", "ICMSSN202", "ICMSSN500", "ICMSSN900"];
                        
                        let icmsGroup = null;
                        let cst = "";
                        let baseCalculo = 0;
                        let aliquota = 0;
                        let valor = 0;
                        
                        for (const group of icmsGroups) {
                            const element = icms.getElementsByTagName(group)[0];
                            if (element) {
                                icmsGroup = element;
                                
                                // CST ou CSOSN
                                cst = getElementText(element, "CST") || getElementText(element, "CSOSN") || "";
                                
                                // Base de cálculo e valores
                                baseCalculo = parseFloat(getElementText(element, "vBC") || "0");
                                aliquota = parseFloat(getElementText(element, "pICMS") || "0");
                                valor = parseFloat(getElementText(element, "vICMS") || "0");
                                
                                break;
                            }
                        }
                        
                        if (icmsGroup) {
                            impostosPorItem.push({
                                itemId: i + 1,
                                tipo: "ICMS",
                                cst: cst,
                                baseCalculo: baseCalculo,
                                aliquota: aliquota,
                                valor: valor
                            });
                        }
                    }
                    
                    // IPI
                    const ipi = imposto.getElementsByTagName("IPI")[0];
                    if (ipi) {
                        const ipitrib = ipi.getElementsByTagName("IPITrib")[0];
                        if (ipitrib) {
                            const cst = getElementText(ipitrib, "CST") || "";
                            const baseCalculo = parseFloat(getElementText(ipitrib, "vBC") || "0");
                            const aliquota = parseFloat(getElementText(ipitrib, "pIPI") || "0");
                            const valor = parseFloat(getElementText(ipitrib, "vIPI") || "0");
                            
                            impostosPorItem.push({
                                itemId: i + 1,
                                tipo: "IPI",
                                cst: cst,
                                baseCalculo: baseCalculo,
                                aliquota: aliquota,
                                valor: valor
                            });
                        }
                    }
                    
                    // PIS
                    const pis = imposto.getElementsByTagName("PIS")[0];
                    if (pis) {
                        const pisAliq = pis.getElementsByTagName("PISAliq")[0];
                        if (pisAliq) {
                            const cst = getElementText(pisAliq, "CST") || "";
                            const baseCalculo = parseFloat(getElementText(pisAliq, "vBC") || "0");
                            const aliquota = parseFloat(getElementText(pisAliq, "pPIS") || "0");
                            const valor = parseFloat(getElementText(pisAliq, "vPIS") || "0");
                            
                            impostosPorItem.push({
                                itemId: i + 1,
                                tipo: "PIS",
                                cst: cst,
                                baseCalculo: baseCalculo,
                                aliquota: aliquota,
                                valor: valor
                            });
                        }
                    }
                    
                    // COFINS
                    const cofins = imposto.getElementsByTagName("COFINS")[0];
                    if (cofins) {
                        const cofinsAliq = cofins.getElementsByTagName("COFINSAliq")[0];
                        if (cofinsAliq) {
                            const cst = getElementText(cofinsAliq, "CST") || "";
                            const baseCalculo = parseFloat(getElementText(cofinsAliq, "vBC") || "0");
                            const aliquota = parseFloat(getElementText(cofinsAliq, "pCOFINS") || "0");
                            const valor = parseFloat(getElementText(cofinsAliq, "vCOFINS") || "0");
                            
                            impostosPorItem.push({
                                itemId: i + 1,
                                tipo: "COFINS",
                                cst: cst,
                                baseCalculo: baseCalculo,
                                aliquota: aliquota,
                                valor: valor
                            });
                        }
                    }
                }
            }
            
            // Verificar inconsistências para alertas de conformidade
            const inconsistencias = [];
            
            // Verificar se o CNPJ do emitente está preenchido
            if (!emitente.cnpj) {
                inconsistencias.push("CNPJ do emitente não informado");
            }
            
            // Verificar se o CNPJ do destinatário está preenchido
            if (!destinatario.cnpj) {
                inconsistencias.push("CNPJ/CPF do destinatário não informado");
            }
            
            // Verificar se há CFOP
            if (!cfopPrincipal && produtos.every(p => !p.cfop)) {
                inconsistencias.push("CFOP não informado");
            }
            
            return {
                tipo: "NFe",
                numero: numeroNF,
                data: data,
                valor: valorTotal,
                cfop: cfopPrincipal,
                emitente: emitente,
                destinatario: destinatario,
                produtos: produtos,
                impostosTotais: impostosTotais,
                impostosPorItem: impostosPorItem,
                inconsistencias: inconsistencias,
                xmlOriginal: xmlDoc.documentElement.outerHTML
            };
        } catch (error) {
            console.error("Erro ao extrair dados da NFe:", error);
            return null;
        }
    }

    // Extrair dados de CTe
    function extrairDadosCTe(xmlDoc) {
        try {
            const inf = xmlDoc.getElementsByTagName("infCte")[0];
            const ide = inf.getElementsByTagName("ide")[0];
            const emit = inf.getElementsByTagName("emit")[0];
            const dest = inf.getElementsByTagName("dest")[0];
            const vPrest = inf.getElementsByTagName("vPrest")[0];
            
            const numeroCT = getElementText(ide, "nCT");
            const data = formatarData(getElementText(ide, "dhEmi"));
            const valorTotal = parseFloat(getElementText(vPrest, "vRec"));
            
            // Informações do emitente
            const emitente = {
                nome: getElementText(emit, "xNome"),
                cnpj: getElementText(emit, "CNPJ")
            };
            
            // Informações do destinatário
            const destinatario = {
                nome: getElementText(dest, "xNome"),
                cnpj: getElementText(dest, "CNPJ") || getElementText(dest, "CPF")
            };
            
            return {
                tipo: "CTe",
                numero: numeroCT,
                data: data,
                valor: valorTotal,
                emitente: emitente,
                destinatario: destinatario,
                xmlOriginal: xmlDoc.documentElement.outerHTML
            };
        } catch (error) {
            console.error("Erro ao extrair dados do CTe:", error);
            return null;
        }
    }

    // Melhorar a função extrairDadosNFSe para capturar dados fiscais
    function extrairDadosNFSe(xmlDoc) {
        try {
            console.log("Tentando extrair NFSe...");
            
            // Verificar o formato específico de NFSe com tag raiz "nfse"
            const nfseRaiz = xmlDoc.getElementsByTagName("nfse")[0];
            if (nfseRaiz) {
                console.log("Formato de NFSe específico encontrado com tag raiz 'nfse'");
                
                // Extrair campos do formato específico
                const nf = nfseRaiz.getElementsByTagName("nf")[0];
                const prestador = nfseRaiz.getElementsByTagName("prestador")[0];
                const tomador = nfseRaiz.getElementsByTagName("tomador")[0];
                const itens = nfseRaiz.getElementsByTagName("itens")[0];
                
                if (!nf) {
                    throw new Error("Estrutura da NFSe incompleta (falta tag nf)");
                }
                
                // Extrair número da nota
                const numeroNFS = getElementTagContent(nf, "numero_nfse");
                if (!numeroNFS) {
                    throw new Error("Número da NFSe não encontrado");
                }
                
                // Extrair data
                const dataNFS = getElementTagContent(nf, "data_nfse");
                
                // Extrair valor
                const valorTotal = parseFloat((getElementTagContent(nf, "valor_total") || "0").replace(',', '.'));
                
                // Dados do prestador
                const cnpjPrestador = prestador ? getElementTagContent(prestador, "cpfcnpj") : null;
                const nomePrestador = prestador ? getElementTagContent(prestador, "nome_razao_social") : ("Prestador " + (cnpjPrestador || ""));
                
                // Dados do tomador
                const nomeTomador = tomador ? (getElementTagContent(tomador, "nome_razao_social") || getElementTagContent(tomador, "sobrenome_nome_fantasia")) : "Consumidor não identificado";
                const cpfCnpjTomador = tomador ? getElementTagContent(tomador, "cpfcnpj") : null;
                
                // Extrair informações fiscais
                const impostosTotais = {
                    valorISS: 0,
                    baseCalculoISS: 0
                };
                
                // Verificar se há itens com valores tributáveis
                if (itens) {
                    const listaItens = itens.getElementsByTagName("lista");
                    for (let i = 0; i < listaItens.length; i++) {
                        const item = listaItens[i];
                        const valorTributavel = parseFloat((getElementTagContent(item, "valor_tributavel") || "0").replace(',', '.'));
                        const valorIssrf = parseFloat((getElementTagContent(item, "valor_issrf") || "0").replace(',', '.'));
                        
                        impostosTotais.baseCalculoISS += valorTributavel;
                        impostosTotais.valorISS += valorIssrf;
                    }
                }
                
                // Adicionar ainda informações gerais de impostos que podem estar no XML
                const valorIss = parseFloat((getElementTagContent(nf, "valor_issqn") || getElementTagContent(nf, "valor_iss") || "0").replace(',', '.'));
                if (valorIss > 0) {
                    impostosTotais.valorISS = valorIss;
                }
            
            return {
                tipo: "NFS-e",
                numero: numeroNFS,
                    data: dataNFS ? formatarData(dataNFS) : new Date().toLocaleDateString(),
                valor: valorTotal,
                    emitente: {
                        nome: nomePrestador,
                        cnpj: cnpjPrestador
                    },
                    destinatario: {
                        nome: nomeTomador,
                        cnpj: cpfCnpjTomador
                    },
                    impostosTotais: impostosTotais,
                    cfop: "", // NFSe normalmente não usa CFOP
                xmlOriginal: xmlDoc.documentElement.outerHTML
            };
            }
            
            // Código existente para outros formatos...
        } catch (error) {
            console.error("Erro ao extrair NFSe:", error);
            return null;
        }
    }

    // Função auxiliar para obter conteúdo de tag XML
    function getElementTagContent(parent, tagName) {
        if (!parent) return null;
        const elements = parent.getElementsByTagName(tagName);
        if (elements && elements.length > 0) {
            return elements[0].textContent.trim();
        }
        return null;
    }

    // Funções auxiliares
    function getElementText(parent, tagName) {
        const elements = parent.getElementsByTagName(tagName);
        if (elements.length > 0) {
            return elements[0].textContent;
        }
        return "";
    }

    function formatarData(dataStr) {
        if (!dataStr) return "";
        
        try {
            // Tratar diferentes formatos de data encontrados em XMLs
            let data;
            if (dataStr.includes("T")) {
                data = new Date(dataStr);
            } else if (dataStr.includes("/")) {
                const partes = dataStr.split("/");
                data = new Date(partes[2], partes[1] - 1, partes[0]);
            } else if (dataStr.length === 8) {
                // Formato AAAAMMDD
                data = new Date(
                    dataStr.substring(0, 4),
                    parseInt(dataStr.substring(4, 6)) - 1,
                    dataStr.substring(6, 8)
                );
            } else {
                data = new Date(dataStr);
            }
            
            return data.toLocaleDateString('pt-BR');
        } catch (e) {
            console.error("Erro ao formatar data:", dataStr, e);
            return dataStr;
        }
    }

    // Atualizar o dashboard
    function atualizarDashboard() {
        if (!db) return;
        
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notas = event.target.result;
            
            // Atualizar tabela de dados
            atualizarTabelaDados(notas);
            
            // Atualizar resumos
            gerarEstatisticas(notas);
            gerarGraficos(notas);
            gerarTabelaDestinatarios(notas);
            gerarTabelaTipos(notas);
            
            // Atualizar dashboard fiscal
            atualizarDashboardFiscal(notas);
        };
        
        request.onerror = function(event) {
            console.error("Erro ao recuperar dados:", event.target.error);
        };
    }

    // Atualizar tabela de dados
    function atualizarTabelaDados(notas) {
        const tbody = document.getElementById('dadosTabela');
        tbody.innerHTML = '';
        
        notas.forEach((nota, index) => {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${nota.numero}</td>
                <td>${nota.data}</td>
                <td>${nota.tipo}</td>
                <td>R$ ${nota.valor.toFixed(2)}</td>
                <td>${nota.emitente.nome}</td>
                <td>${nota.destinatario.nome}</td>
                <td>${nota.destinatario.cnpj}</td>
                <td><button class="btn btn-sm btn-info" onclick="mostrarDetalhes(${index})">Detalhes</button></td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Adicionar filtro de tabela
        document.getElementById('filtroTabela').addEventListener('keyup', function() {
            const termo = this.value.toLowerCase();
            const linhas = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i];
                const texto = linha.textContent.toLowerCase();
                
                if (texto.includes(termo)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            }
        });
        
        // Adicionar função global para mostrar detalhes
        window.mostrarDetalhes = function(index) {
            const nota = notas[index];
            const modal = new bootstrap.Modal(document.getElementById('detalheModal'));
            const conteudo = document.getElementById('detalheConteudo');
            
            let detalhes = `
                <h6>Informações Gerais</h6>
                <p><strong>Tipo:</strong> ${nota.tipo}</p>
                <p><strong>Número:</strong> ${nota.numero}</p>
                <p><strong>Data:</strong> ${nota.data}</p>
                <p><strong>Valor Total:</strong> R$ ${nota.valor.toFixed(2)}</p>
                
                <h6>Emitente</h6>
                <p><strong>Nome:</strong> ${nota.emitente.nome}</p>
                <p><strong>CNPJ/CPF:</strong> ${nota.emitente.cnpj}</p>
                
                <h6>Destinatário</h6>
                <p><strong>Nome:</strong> ${nota.destinatario.nome}</p>
                <p><strong>CNPJ/CPF:</strong> ${nota.destinatario.cnpj}</p>
            `;
            
            // Adicionar produtos se existirem
            if (nota.produtos && nota.produtos.length > 0) {
                detalhes += '<h6>Produtos</h6><div class="table-responsive"><table class="table table-sm">';
                detalhes += '<thead><tr><th>Código</th><th>Descrição</th><th>Qtde</th><th>Valor Unit.</th><th>Valor Total</th></tr></thead><tbody>';
                
                nota.produtos.forEach(prod => {
                    detalhes += `<tr>
                        <td>${prod.codigo}</td>
                        <td>${prod.descricao}</td>
                        <td>${prod.quantidade}</td>
                        <td>R$ ${prod.valorUnitario.toFixed(2)}</td>
                        <td>R$ ${prod.valorTotal.toFixed(2)}</td>
                    </tr>`;
                });
                
                detalhes += '</tbody></table></div>';
            }
            
            conteudo.innerHTML = detalhes;
            modal.show();
        };
    }

    // Gerar estatísticas
    function gerarEstatisticas(notas) {
        const estatisticas = document.getElementById('estatisticas');
        
        // Calcular estatísticas
        const totalNotas = notas.length;
        const valorTotal = notas.reduce((total, nota) => total + nota.valor, 0);
        
        // Contar tipos de documentos
        const tiposDoc = {};
        notas.forEach(nota => {
            tiposDoc[nota.tipo] = (tiposDoc[nota.tipo] || 0) + 1;
        });
        
        // Período
        let dataMin = null;
        let dataMax = null;
        
        notas.forEach(nota => {
            const dataParts = nota.data.split('/');
            const data = new Date(dataParts[2], dataParts[1] - 1, dataParts[0]);
            
            if (dataMin === null || data < dataMin) {
                dataMin = data;
            }
            
            if (dataMax === null || data > dataMax) {
                dataMax = data;
            }
        });
        
        let periodoTexto = '';
        if (dataMin && dataMax) {
            periodoTexto = `${dataMin.toLocaleDateString('pt-BR')} a ${dataMax.toLocaleDateString('pt-BR')}`;
        }
        
        // Exibir estatísticas
        let html = `
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5>Total de Notas</h5>
                            <h3>${totalNotas}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5>Valor Total</h5>
                            <h3>R$ ${valorTotal.toFixed(2)}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5>Tipos de Notas</h5>
                            <h3>${Object.keys(tiposDoc).length}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h5>Período</h5>
                            <p>${periodoTexto}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        estatisticas.innerHTML = html;
    }

    // Gerar gráficos
    function gerarGraficos(notas) {
        // Gráfico por tipo de nota
        const tiposNotas = {};
        const valoresPorTipo = {};
        
        notas.forEach(nota => {
            tiposNotas[nota.tipo] = (tiposNotas[nota.tipo] || 0) + 1;
            valoresPorTipo[nota.tipo] = (valoresPorTipo[nota.tipo] || 0) + nota.valor;
        });
        
        const tiposLabels = Object.keys(tiposNotas);
        const tiposValues = tiposLabels.map(tipo => tiposNotas[tipo]);
        const tiposValores = tiposLabels.map(tipo => valoresPorTipo[tipo]);
        
        // Gráfico por destinatário
        const valorPorDestinatario = {};
        
        notas.forEach(nota => {
            const dest = nota.destinatario.nome;
            valorPorDestinatario[dest] = (valorPorDestinatario[dest] || 0) + nota.valor;
        });
        
        // Ordenar e pegar os top 5
        const destinatariosOrdenados = Object.entries(valorPorDestinatario)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        const destLabels = destinatariosOrdenados.map(item => item[0]);
        const destValues = destinatariosOrdenados.map(item => item[1]);
        
        // Renderizar os gráficos
        const ctx1 = document.getElementById('tipoChart');
        const ctx2 = document.getElementById('destinatarioChart');
        
        if (window.chartTipo) window.chartTipo.destroy();
        if (window.chartDest) window.chartDest.destroy();
        
        window.chartTipo = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: tiposLabels,
                datasets: [
                    {
                        label: 'Quantidade',
                        data: tiposValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Valor Total (R$)',
                        data: tiposValores,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        }
                    }
                }
            }
        });
        
        window.chartDest = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: destLabels,
                datasets: [{
                    data: destValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                return `R$ ${value.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Gerar tabela de destinatários
    function gerarTabelaDestinatarios(notas) {
        const destinatarios = {};
        
        notas.forEach(nota => {
            const dest = nota.destinatario.nome;
            const cnpj = nota.destinatario.cnpj;
            
            if (!destinatarios[dest]) {
                destinatarios[dest] = {
                    cnpj: cnpj,
                    total: 0,
                    quantidade: 0,
                    tipos: {}
                };
            }
            
            destinatarios[dest].total += nota.valor;
            destinatarios[dest].quantidade++;
            destinatarios[dest].tipos[nota.tipo] = (destinatarios[dest].tipos[nota.tipo] || 0) + 1;
        });
        
        // Ordenar por valor total
        const destinatariosArray = Object.entries(destinatarios)
            .map(([nome, dados]) => ({
                nome,
                ...dados
            }))
            .sort((a, b) => b.total - a.total);
        
        // Renderizar tabela
        const container = document.getElementById('tabelaDestinatarios');
        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Destinatário</th>
                            <th>CNPJ/CPF</th>
                            <th>Quantidade</th>
                            <th>Valor Total</th>
                            <th>Tipos de Notas</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        destinatariosArray.forEach(dest => {
            const tiposStr = Object.entries(dest.tipos)
                .map(([tipo, qtd]) => `${tipo}: ${qtd}`)
                .join(', ');
            
            html += `
                <tr>
                    <td>${dest.nome}</td>
                    <td>${dest.cnpj}</td>
                    <td>${dest.quantidade}</td>
                    <td>R$ ${dest.total.toFixed(2)}</td>
                    <td>${tiposStr}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Gerar tabela por tipos
    function gerarTabelaTipos(notas) {
        const tipos = {};
        
        notas.forEach(nota => {
            const tipo = nota.tipo;
            
            if (!tipos[tipo]) {
                tipos[tipo] = {
                    quantidade: 0,
                    total: 0,
                    destinatarios: {}
                };
            }
            
            tipos[tipo].quantidade++;
            tipos[tipo].total += nota.valor;
            
            const dest = nota.destinatario.nome;
            tipos[tipo].destinatarios[dest] = (tipos[tipo].destinatarios[dest] || 0) + 1;
        });
        
        // Renderizar tabela
        const container = document.getElementById('tabelaTipos');
        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tipo de Nota</th>
                            <th>Quantidade</th>
                            <th>Valor Total</th>
                            <th>Média por Nota</th>
                            <th>Principais Destinatários</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        Object.entries(tipos).forEach(([tipo, dados]) => {
            // Pegar os 3 principais destinatários
            const principaisDest = Object.entries(dados.destinatarios)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([nome, qtd]) => `${nome} (${qtd})`)
                .join(', ');
            
            const media = dados.total / dados.quantidade;
            
            html += `
                <tr>
                    <td>${tipo}</td>
                    <td>${dados.quantidade}</td>
                    <td>R$ ${dados.total.toFixed(2)}</td>
                    <td>R$ ${media.toFixed(2)}</td>
                    <td>${principaisDest}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Salvar no banco de dados - Função não mais usada diretamente
    function salvarNoBanco(dados) {
        const transaction = db.transaction(["notas"], "readwrite");
        const store = transaction.objectStore("notas");
        
        const request = store.add(dados);
        
        request.onerror = function(event) {
            console.error("Erro ao salvar no banco de dados:", event.target.error);
        };
    }

    // Adicionar esta função no final do script
    function atualizarDashboardFiscal(notas) {
        // Preencher o seletor de emitentes
        const seletorEmitente = document.getElementById('seletorEmitenteImposto');
        seletorEmitente.innerHTML = '<option value="todos">Todos os Emitentes</option>';
        
        // Coletar todos os emitentes únicos
        const emitentes = {};
        notas.forEach(nota => {
            if (nota.emitente && nota.emitente.nome) {
                emitentes[nota.emitente.cnpj] = nota.emitente.nome;
            }
        });
        
        // Adicionar emitentes ao seletor
        Object.entries(emitentes).forEach(([cnpj, nome]) => {
            seletorEmitente.innerHTML += `<option value="${cnpj}">${nome}</option>`;
        });
        
        // Extrair dados de impostos de todas as notas
        const dadosImpostos = extrairDadosImpostos(notas);
        
        // Mostrar resumo de impostos
        mostrarResumoImpostos(dadosImpostos);
        
        // Gerar gráficos
        gerarGraficoImpostosPorTipo(dadosImpostos);
        gerarGraficoCFOPs(notas);
        
        // Preencher tabela detalhada de impostos
        preencherTabelaImpostosDetalhados(dadosImpostos);
        
        // Verificar conformidade
        verificarConformidade(notas);
        
        // Adicionar evento de filtro de emitente
        seletorEmitente.addEventListener('change', function() {
            const emitenteSelecionado = this.value;
            
            // Filtrar notas pelo emitente selecionado
            const notasFiltradas = emitenteSelecionado === 'todos' ? 
                notas : 
                notas.filter(nota => nota.emitente && nota.emitente.cnpj === emitenteSelecionado);
            
            // Atualizar dados com o filtro aplicado
            const dadosImpostosFiltrados = extrairDadosImpostos(notasFiltradas);
            mostrarResumoImpostos(dadosImpostosFiltrados);
            gerarGraficoImpostosPorTipo(dadosImpostosFiltrados);
            preencherTabelaImpostosDetalhados(dadosImpostosFiltrados);
        });
        
        // Adicionar evento de filtro de tipo de imposto
        document.getElementById('filtroTipoImpostoDetalhado').addEventListener('change', function() {
            const tipoImposto = this.value;
            
            // Filtrar impostos pelo tipo selecionado
            let impostosFiltrados = dadosImpostos.impostosPorItem;
            
            if (tipoImposto !== 'todos') {
                impostosFiltrados = impostosFiltrados.filter(imp => imp.tipo === tipoImposto);
            }
            
            // Atualizar tabela com filtro aplicado
            preencherTabelaImpostosDetalhadosComDados(impostosFiltrados, dadosImpostos.notasPorId);
        });
    }

    // Função melhorada para extrair dados de impostos
    function extrairDadosImpostos(notas) {
        console.log(`Extraindo dados de impostos de ${notas.length} notas...`);
        
        // Estrutura para agrupar impostos
        const resumoImpostos = {
            ICMS: { baseCalculo: 0, total: 0 },
            IPI: { baseCalculo: 0, total: 0 },
            PIS: { baseCalculo: 0, total: 0 },
            COFINS: { baseCalculo: 0, total: 0 },
            ISS: { baseCalculo: 0, total: 0 }
        };
        
        // Arrays e objetos para armazenar dados detalhados
        const impostosPorItem = [];
        const notasPorId = {};
        
        // Processar cada nota
        for (const nota of notas) {
            // Armazenar referência da nota
            if (nota.numero) {
                notasPorId[nota.numero] = nota;
            }
            
            try {
                // Verificar e processar impostos totais
                if (nota.impostosTotais) {
                    // ICMS
                    if (Number.isFinite(parseFloat(nota.impostosTotais.valorICMS))) {
                        resumoImpostos.ICMS.total += parseFloat(nota.impostosTotais.valorICMS);
                        resumoImpostos.ICMS.baseCalculo += parseFloat(nota.impostosTotais.baseCalculoICMS || 0);
                    }
                    
                    // IPI
                    if (Number.isFinite(parseFloat(nota.impostosTotais.valorIPI))) {
                        resumoImpostos.IPI.total += parseFloat(nota.impostosTotais.valorIPI);
                        resumoImpostos.IPI.baseCalculo += parseFloat(nota.impostosTotais.baseCalculoIPI || 0);
                    }
                    
                    // PIS
                    if (Number.isFinite(parseFloat(nota.impostosTotais.valorPIS))) {
                        resumoImpostos.PIS.total += parseFloat(nota.impostosTotais.valorPIS);
                        resumoImpostos.PIS.baseCalculo += parseFloat(nota.impostosTotais.baseCalculoPIS || 0);
                    }
                    
                    // COFINS
                    if (Number.isFinite(parseFloat(nota.impostosTotais.valorCOFINS))) {
                        resumoImpostos.COFINS.total += parseFloat(nota.impostosTotais.valorCOFINS);
                        resumoImpostos.COFINS.baseCalculo += parseFloat(nota.impostosTotais.baseCalculoCOFINS || 0);
                    }
                    
                    // ISS
                    if (Number.isFinite(parseFloat(nota.impostosTotais.valorISS))) {
                        resumoImpostos.ISS.total += parseFloat(nota.impostosTotais.valorISS);
                        resumoImpostos.ISS.baseCalculo += parseFloat(nota.impostosTotais.baseCalculoISS || 0);
                    }
                }
                
                // Processar impostos por item
                if (Array.isArray(nota.impostosPorItem) && nota.impostosPorItem.length > 0) {
                    for (const imposto of nota.impostosPorItem) {
                        if (imposto && imposto.tipo) {
                            // Adicionar ao array de detalhes
                            impostosPorItem.push({
                                notaId: nota.numero || "Desconhecido",
                                tipo: imposto.tipo,
                                cst: imposto.cst || "-",
                                baseCalculo: parseFloat(imposto.baseCalculo || 0),
                                aliquota: parseFloat(imposto.aliquota || 0),
                                valor: parseFloat(imposto.valor || 0)
                            });
                            
                            // Adicionar valores ao resumo total
                            if (resumoImpostos[imposto.tipo]) {
                                resumoImpostos[imposto.tipo].total += parseFloat(imposto.valor || 0);
                                resumoImpostos[imposto.tipo].baseCalculo += parseFloat(imposto.baseCalculo || 0);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`Erro ao processar nota ${nota.numero}:`, error);
            }
        }
        
        console.log("Resumo de impostos extraído:", resumoImpostos);
        
        return {
            resumoImpostos: resumoImpostos,
            impostosPorItem: impostosPorItem,
            notasPorId: notasPorId
        };
    }

    // Corrigir a função de mostrar resumo de impostos para evitar erros de renderização
    function mostrarResumoImpostos(dadosImpostos) {
        console.log("Mostrando resumo de impostos:", dadosImpostos);
        
        const container = document.getElementById('resumoImpostosEmitente');
        
        // Garantir que temos dados válidos para mostrar
        if (!dadosImpostos || !dadosImpostos.resumoImpostos) {
            container.innerHTML = '<div class="alert alert-info">Não há dados de impostos disponíveis para as notas selecionadas.</div>';
            return;
        }
        
        const resumo = dadosImpostos.resumoImpostos;
        
        // Formatar valores com precisão de 2 casas decimais
        const formatarValor = (valor) => {
            if (valor === undefined || valor === null) return '0.00';
            return typeof valor === 'number' ? valor.toFixed(2) : parseFloat(valor || 0).toFixed(2);
        };
        
        const html = `
            <div class="row">
                <div class="col-md-2">
                    <div class="card bg-primary text-white mb-3">
                        <div class="card-body text-center">
                            <h5>ICMS</h5>
                            <h3>R$ ${formatarValor(resumo.ICMS?.total)}</h3>
                            <small>Base: R$ ${formatarValor(resumo.ICMS?.baseCalculo)}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white mb-3">
                        <div class="card-body text-center">
                            <h5>IPI</h5>
                            <h3>R$ ${formatarValor(resumo.IPI?.total)}</h3>
                            <small>Base: R$ ${formatarValor(resumo.IPI?.baseCalculo)}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white mb-3">
                        <div class="card-body text-center">
                            <h5>PIS</h5>
                            <h3>R$ ${formatarValor(resumo.PIS?.total)}</h3>
                            <small>Base: R$ ${formatarValor(resumo.PIS?.baseCalculo)}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning mb-3">
                        <div class="card-body text-center">
                            <h5>COFINS</h5>
                            <h3>R$ ${formatarValor(resumo.COFINS?.total)}</h3>
                            <small>Base: R$ ${formatarValor(resumo.COFINS?.baseCalculo)}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white mb-3">
                        <div class="card-body text-center">
                            <h5>ISS</h5>
                            <h3>R$ ${formatarValor(resumo.ISS?.total)}</h3>
                            <small>Base: R$ ${formatarValor(resumo.ISS?.baseCalculo)}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-dark text-white mb-3">
                        <div class="card-body text-center">
                            <h5>Total Impostos</h5>
                            <h3>R$ ${formatarValor(
                                (parseFloat(resumo.ICMS?.total || 0)) + 
                                (parseFloat(resumo.IPI?.total || 0)) + 
                                (parseFloat(resumo.PIS?.total || 0)) + 
                                (parseFloat(resumo.COFINS?.total || 0)) + 
                                (parseFloat(resumo.ISS?.total || 0))
                            )}</h3>
                            <small>&nbsp;</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    // Função corrigida para gerar o gráfico de impostos por tipo
    function gerarGraficoImpostosPorTipo(dadosImpostos) {
        console.log("Gerando gráfico de impostos por tipo:", dadosImpostos);
        
        // Verificar se o elemento existe
        const canvas = document.getElementById('impostosPorTipoChart');
        if (!canvas) {
            console.error("Elemento 'impostosPorTipoChart' não encontrado");
            return;
        }
        
        // Obter o contexto 2D do canvas
        try {
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error("Não foi possível obter o contexto do canvas");
                return;
            }
        
            // Verificar se o gráfico já existe e destruí-lo
            if (window.impostosPorTipoChart) {
                window.impostosPorTipoChart.destroy();
            }
            
            // Garantir que temos dados válidos
            let labels = [];
            let valores = [];
            
            if (dadosImpostos && dadosImpostos.resumoImpostos) {
                const resumo = dadosImpostos.resumoImpostos;
                
                // Extrair dados para o gráfico
                labels = ['ICMS', 'IPI', 'PIS', 'COFINS', 'ISS'];
                valores = [
                    parseFloat(resumo.ICMS?.total || 0),
                    parseFloat(resumo.IPI?.total || 0),
                    parseFloat(resumo.PIS?.total || 0),
                    parseFloat(resumo.COFINS?.total || 0),
                    parseFloat(resumo.ISS?.total || 0)
                ];
            }
            
            // Criar gráfico mesmo sem dados (para evitar erros)
            window.impostosPorTipoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor Total (R$)',
                        data: valores,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao criar o gráfico de impostos por tipo:", error);
        }
    }

    // Função corrigida para gerar o gráfico de CFOPs
    function gerarGraficoCFOPs(notas) {
        console.log("Gerando gráfico de CFOPs");
        
        // Verificar se o elemento existe
        const canvas = document.getElementById('cfopChart');
        if (!canvas) {
            console.error("Elemento 'cfopChart' não encontrado");
            return;
        }
        
        try {
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error("Não foi possível obter o contexto do canvas");
                return;
            }
            
            // Verificar se o gráfico já existe e destruí-lo
            if (window.cfopChart) {
                window.cfopChart.destroy();
            }
            
            // Contagem de CFOPs
            const cfopCount = {};
            notas.forEach(nota => {
                if (nota.cfop) {
                    if (!cfopCount[nota.cfop]) {
                        cfopCount[nota.cfop] = 0;
                    }
                    cfopCount[nota.cfop]++;
                }
                
                // Verificar CFOPs nos itens
                if (nota.produtos && nota.produtos.length > 0) {
                    nota.produtos.forEach(produto => {
                        if (produto.cfop) {
                            if (!cfopCount[produto.cfop]) {
                                cfopCount[produto.cfop] = 0;
                            }
                            cfopCount[produto.cfop]++;
                        }
                    });
                }
            });
            
            // Ordenar por frequência e pegar os 5 mais comuns
            const cfopData = Object.entries(cfopCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const labels = cfopData.map(item => `CFOP ${item[0]}`);
            const data = cfopData.map(item => item[1]);
            
            // Criar o gráfico
            window.cfopChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.length > 0 ? labels : ['Sem dados'],
                    datasets: [{
                        data: data.length > 0 ? data : [1],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao criar o gráfico de CFOPs:", error);
        }
    }

    // Preencher tabela detalhada de impostos
    function preencherTabelaImpostosDetalhados(dadosImpostos) {
        preencherTabelaImpostosDetalhadosComDados(dadosImpostos.impostosPorItem, dadosImpostos.notasPorId);
    }

    function preencherTabelaImpostosDetalhadosComDados(impostos, notasPorId) {
        const tbody = document.getElementById('dadosImpostosDetalhados');
        tbody.innerHTML = '';
        
        if (impostos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum dado de imposto encontrado</td></tr>';
            return;
        }
        
        impostos.forEach(imposto => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${imposto.numero}</td>
                <td>${imposto.emitente}</td>
                <td>${imposto.data}</td>
                <td>${imposto.tipo}</td>
                <td>R$ ${imposto.baseCalculo.toFixed(2)}</td>
                <td>${imposto.aliquota.toFixed(2)}%</td>
                <td>R$ ${imposto.valor.toFixed(2)}</td>
                <td>${imposto.cst}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Verificar conformidade das notas
    function verificarConformidade(notas) {
        const container = document.getElementById('alertasConformidade');
        container.innerHTML = '';
        
        const alertas = [];
        
        notas.forEach(nota => {
            if (nota.inconsistencias && nota.inconsistencias.length > 0) {
                nota.inconsistencias.forEach(inconsistencia => {
                    alertas.push({
                        nota: nota.numero,
                        tipo: nota.tipo,
                        data: nota.data,
                        emitente: nota.emitente.nome,
                        inconsistencia: inconsistencia
                    });
                });
            }
        });
        
        if (alertas.length === 0) {
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Nenhuma inconsistência encontrada nas notas fiscais.
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> Foram encontradas ${alertas.length} inconsistências.
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Nota</th>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Emitente</th>
                            <th>Inconsistência</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        alertas.forEach(alerta => {
            html += `
                <tr>
                    <td>${alerta.nota}</td>
                    <td>${alerta.tipo}</td>
                    <td>${alerta.data}</td>
                    <td>${alerta.emitente}</td>
                    <td>${alerta.inconsistencia}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Modificar a função de adicionar filtros avançados para incluir opção "Qualquer data"
    function adicionarFiltrosAvancados() {
        // Adicionar painel de filtros avançados
        const cardResumo = document.querySelector('#fiscal .row:first-child .card');
        const filtrosAvancados = document.createElement('div');
        filtrosAvancados.className = 'card mb-4';
        filtrosAvancados.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Filtros Avançados</span>
                <div>
                    <button id="btnAplicarFiltros" class="btn btn-sm btn-primary">Aplicar Filtros</button>
                    <button id="btnSalvarFiltro" class="btn btn-sm btn-outline-success">Salvar Filtro</button>
                    <button id="btnGerenciarFiltros" class="btn btn-sm btn-outline-secondary">Gerenciar Filtros</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Período</label>
                        <div class="d-flex align-items-center mb-2">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="qualquerData" checked>
                                <label class="form-check-label" for="qualquerData">Qualquer data</label>
                            </div>
                        </div>
                        <div class="d-flex" id="camposData">
                            <input type="date" id="filtroDataInicio" class="form-control form-control-sm me-2" disabled>
                            <input type="date" id="filtroDataFim" class="form-control form-control-sm" disabled>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Emitente</label>
                        <select id="filtroEmitente" class="form-select form-select-sm" multiple>
                            <option value="todos" selected>Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Tipo de Documento</label>
                        <select id="filtroTipoDoc" class="form-select form-select-sm">
                            <option value="todos" selected>Todos</option>
                            <option value="NFe">NF-e</option>
                            <option value="NFS-e">NFS-e</option>
                            <option value="CTe">CT-e</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Valor mínimo</label>
                        <input type="number" id="filtroValorMinimo" class="form-control form-control-sm" placeholder="Valor mínimo">
                    </div>
                </div>
                <div class="row" id="filtrosCFOP">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">CFOPs</label>
                        <input type="text" id="filtroCFOP" class="form-control form-control-sm" placeholder="Ex: 5102, 6102 (separados por vírgula)">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Filtragem avançada de impostos</label>
                        <div class="d-flex">
                            <select id="filtroTipoImposto" class="form-select form-select-sm me-2">
                                <option value="">Selecione o imposto</option>
                                <option value="ICMS">ICMS</option>
                                <option value="IPI">IPI</option>
                                <option value="PIS">PIS</option>
                                <option value="COFINS">COFINS</option>
                                <option value="ISS">ISS</option>
                            </select>
                            <select id="filtroComparacao" class="form-select form-select-sm me-2">
                                <option value=">=">Maior ou igual</option>
                                <option value="<=">Menor ou igual</option>
                                <option value="=">Igual</option>
                            </select>
                            <input type="number" id="filtroValorImposto" class="form-control form-select-sm" placeholder="Valor">
                            <button id="btnAdicionarFiltroImposto" class="btn btn-sm btn-outline-primary ms-2">+</button>
                        </div>
                        <div id="filtrosImpostosAplicados" class="mt-2">
                            <!-- Filtros adicionados aparecerão aqui -->
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Inserir antes do card de resumo
        cardResumo.parentNode.parentNode.insertBefore(filtrosAvancados, cardResumo.parentNode.parentNode.firstChild);
        
        // Adicionar controle para o checkbox "Qualquer data"
        document.getElementById('qualquerData').addEventListener('change', function() {
            const dataInicio = document.getElementById('filtroDataInicio');
            const dataFim = document.getElementById('filtroDataFim');
            
            if (this.checked) {
                dataInicio.disabled = true;
                dataFim.disabled = true;
                dataInicio.value = '';
                dataFim.value = '';
            } else {
                dataInicio.disabled = false;
                dataFim.disabled = false;
                
                // Inicializar com o mês atual
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                dataInicio.valueAsDate = inicioMes;
                dataFim.valueAsDate = fimMes;
            }
        });
    }

    // Função para carregar todos os emitentes em um array
    function carregarEmitentesParaFiltro(notas) {
        const emitenteSelect = document.getElementById('filtroEmitente');
        emitenteSelect.innerHTML = '<option value="todos" selected>Todos</option>';
        
        // Coletar emitentes únicos
        const emitentes = {};
        notas.forEach(nota => {
            if (nota.emitente && nota.emitente.nome) {
                const cnpj = nota.emitente.cnpj || '';
                emitentes[cnpj] = nota.emitente.nome;
            }
        });
        
        // Adicionar ao select
        Object.entries(emitentes).forEach(([cnpj, nome]) => {
            const option = document.createElement('option');
            option.value = cnpj;
            option.textContent = nome;
            emitenteSelect.appendChild(option);
        });
        
        // Inicializar select2 para melhor usabilidade
        inicializarSelect2();
    }

    // Inicializar biblioteca select2 para melhorar a experiência de seleção múltipla
    function inicializarSelect2() {
        // Verificar se o script do select2 já foi carregado
        if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
            // Carregar jQuery e Select2 se não estiverem disponíveis
            const jqueryScript = document.createElement('script');
            jqueryScript.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
            document.head.appendChild(jqueryScript);
            
            jqueryScript.onload = function() {
                const select2Script = document.createElement('script');
                select2Script.src = 'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js';
                document.head.appendChild(select2Script);
                
                const select2Style = document.createElement('link');
                select2Style.rel = 'stylesheet';
                select2Style.href = 'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css';
                document.head.appendChild(select2Style);
                
                select2Script.onload = function() {
                    $('#filtroEmitente').select2({
                        placeholder: 'Selecione um ou mais emitentes',
                        allowClear: true
                    });
                };
            };
        } else {
            // Se já estiver carregado, apenas inicialize
            $('#filtroEmitente').select2({
                placeholder: 'Selecione um ou mais emitentes',
                allowClear: true
            });
        }
    }

    // Inicializar eventos dos filtros
    function inicializarEventosFiltros() {
        // Botão para adicionar filtro de imposto
        document.getElementById('btnAdicionarFiltroImposto').addEventListener('click', function() {
            const tipoImposto = document.getElementById('filtroTipoImposto').value;
            const comparacao = document.getElementById('filtroComparacao').value;
            const valorImposto = document.getElementById('filtroValorImposto').value;
            
            if (!tipoImposto || !valorImposto) {
                alert('Selecione o tipo de imposto e informe um valor.');
                return;
            }
            
            const filtroId = 'filtro_' + Date.now();
            const filtroHTML = `
                <div id="${filtroId}" class="badge bg-info text-dark p-2 me-2 mb-1">
                    ${tipoImposto} ${comparacao} R$ ${valorImposto}
                    <span class="ms-1 cursor-pointer" onclick="removerFiltroImposto('${filtroId}')" style="cursor:pointer;">×</span>
                    <input type="hidden" class="filtro-imposto-config" 
                           data-tipo="${tipoImposto}" 
                           data-comparacao="${comparacao}" 
                           data-valor="${valorImposto}">
                </div>
            `;
            
            document.getElementById('filtrosImpostosAplicados').insertAdjacentHTML('beforeend', filtroHTML);
            
            // Limpar campos
            document.getElementById('filtroTipoImposto').value = '';
            document.getElementById('filtroValorImposto').value = '';
        });
        
        // Botão para aplicar filtros
        document.getElementById('btnAplicarFiltros').addEventListener('click', function() {
            aplicarFiltrosAvancados();
        });
        
        // Botão para salvar filtro
        document.getElementById('btnSalvarFiltro').addEventListener('click', function() {
            salvarFiltroAtual();
        });
        
        // Botão para gerenciar filtros
        document.getElementById('btnGerenciarFiltros').addEventListener('click', function() {
            mostrarGerenciadorFiltros();
        });
    }

    // Função para remover um filtro de imposto
    window.removerFiltroImposto = function(filtroId) {
        document.getElementById(filtroId).remove();
    };

    // Versão corrigida da função de aplicar filtros avançados
    function aplicarFiltrosAvancados() {
        console.log("Aplicando filtros de forma corrigida...");
        
        // Verificar se "Qualquer data" está marcado
        const qualquerData = document.getElementById('qualquerData').checked;
        
        // Obter todos os valores de filtro
        const dataInicio = qualquerData ? null : document.getElementById('filtroDataInicio').value;
        const dataFim = qualquerData ? null : document.getElementById('filtroDataFim').value;
        const tipoDoc = document.getElementById('filtroTipoDoc').value;
        const valorMinimo = parseFloat(document.getElementById('filtroValorMinimo').value || '0');
        const cfopTexto = document.getElementById('filtroCFOP').value;
        const cfops = cfopTexto.split(',').map(c => c.trim()).filter(c => c);
        
        // Obter emitentes selecionados
        const emitenteSelect = document.getElementById('filtroEmitente');
        const emitentes = Array.from(emitenteSelect.selectedOptions).map(opt => opt.value);
        const todosEmitentes = emitentes.includes('todos');
        
        // Obter todas as notas do banco de dados
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notasOriginais = event.target.result;
            console.log(`Total de notas no banco: ${notasOriginais.length}`);
            
            if (notasOriginais.length === 0) {
                alert("Não há notas no banco de dados.");
                return;
            }
            
            // Filtrar as notas
            const notasFiltradas = notasOriginais.filter(nota => {
                // 1. Filtrar por data (se não for "Qualquer data")
                if (!qualquerData && dataInicio && dataFim) {
                    try {
                        // Converter a data da nota para objeto Date
                        let dataObj;
                        if (nota.data && nota.data.includes('/')) {
                            const partes = nota.data.split('/');
                            dataObj = new Date(partes[2], partes[1]-1, partes[0]);
                        } else {
                            dataObj = new Date(nota.data);
                        }
                        
                        const dataInicioObj = new Date(dataInicio);
                        const dataFimObj = new Date(dataFim);
                        dataFimObj.setHours(23, 59, 59); // Final do dia
                        
                        if (dataObj < dataInicioObj || dataObj > dataFimObj) {
                            return false;
                        }
                    } catch (error) {
                        console.warn(`Erro ao processar data da nota ${nota.numero}:`, error);
                        return false;
                    }
                }
                
                // 2. Filtrar por tipo de documento
                if (tipoDoc !== 'todos' && nota.tipo !== tipoDoc) {
                    return false;
                }
                
                // 3. Filtrar por valor mínimo
                if (valorMinimo > 0) {
                    const valorNota = parseFloat(nota.valor || 0);
                    if (valorNota < valorMinimo) {
                        return false;
                    }
                }
                
                // 4. Filtrar por emitente
                if (!todosEmitentes && nota.emitente && nota.emitente.cnpj) {
                    if (!emitentes.includes(nota.emitente.cnpj)) {
                        return false;
                    }
                }
                
                // 5. Filtrar por CFOP
                if (cfops.length > 0 && nota.cfop) {
                    const notaCfop = nota.cfop.toString();
                    if (!cfops.some(cfop => notaCfop.includes(cfop))) {
                        return false;
                    }
                }
                
                // Nota passou por todos os filtros
                return true;
            });
            
            console.log(`Filtros aplicados: ${notasFiltradas.length} notas encontradas.`);
            
            // Atualizar status do filtro na interface
            const mensagemFiltro = `Filtro aplicado: ${notasFiltradas.length} notas encontradas.`;
            
            // Verificar se já existe uma área de status de filtro
            let filtroStatus = document.getElementById('filtroStatus');
            if (!filtroStatus) {
                filtroStatus = document.createElement('div');
                filtroStatus.id = 'filtroStatus';
                filtroStatus.className = 'alert alert-info d-flex justify-content-between align-items-center mt-2';
                
                // Adicionar no topo do container fiscal
                const fiscalContainer = document.querySelector('#fiscal');
                if (fiscalContainer) {
                    fiscalContainer.prepend(filtroStatus);
                }
            }
            
            filtroStatus.innerHTML = `
                <span>${mensagemFiltro}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="limparFiltros()">Limpar Filtros</button>
            `;
            
            // Atualizar o dashboard com as notas filtradas
            atualizarDashboardComNotasFiltradas(notasFiltradas);
        };
        
        request.onerror = function(event) {
            console.error("Erro ao buscar notas:", event.target.error);
            alert("Ocorreu um erro ao buscar as notas. Consulte o console para mais detalhes.");
        };
    }

    // Função auxiliar para debug - mostra estrutura das notas
    function mostrarEstruturaNotas(notas) {
        if (notas.length === 0) {
            console.log("Nenhuma nota para analisar");
            return;
        }
        
        // Mostrar as chaves presentes em cada nota
        const amostra = notas[0];
        console.log("Estrutura da primeira nota:", Object.keys(amostra));
        console.log("Amostra completa:", amostra);
        
        // Verificar campos importantes em todas as notas
        const estatisticas = {
            comData: 0,
            comCFOP: 0,
            comImpostos: 0,
            comEmitente: 0
        };
        
        notas.forEach(nota => {
            if (nota.data) estatisticas.comData++;
            if (nota.cfop) estatisticas.comCFOP++;
            if (nota.impostosTotais) estatisticas.comImpostos++;
            if (nota.emitente && nota.emitente.cnpj) estatisticas.comEmitente++;
        });
        
        console.log("Estatísticas das notas:", estatisticas, "de", notas.length, "notas");
    }

    // Substituir a função de atualização do dashboard com notas filtradas
    function atualizarDashboardComNotasFiltradas(notasFiltradas) {
        console.log(`Atualizando dashboard com ${notasFiltradas ? notasFiltradas.length : 0} notas`);
        
        // Extrair dados de impostos
        const dadosImpostos = extrairDadosImpostos(notasFiltradas || []);
        
        // Atualizar o resumo de impostos
        mostrarResumoImpostos(dadosImpostos);
        
        // Atualizar os gráficos fiscais
        atualizarDadosGraficosFiscais(dadosImpostos, notasFiltradas);
        
        // Atualizar a tabela detalhada
        preencherTabelaImpostosDetalhados(dadosImpostos);
        
        // Verificar conformidade
        verificarConformidade(notasFiltradas || []);
    }

    // Função para mostrar resultados do filtro
    function mostrarResultadosFiltro(quantidade) {
        // Criar ou atualizar o modal de resultados de filtro
        let modalResultados = document.getElementById('resultadoFiltroModal');
        
        if (!modalResultados) {
            const modalHTML = `
                <div class="modal fade" id="resultadoFiltroModal" tabindex="-1">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Resultado do Filtro</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="mensagemResultadoFiltro">Filtro aplicado: <b>${quantidade}</b> notas encontradas.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div');
            container.innerHTML = modalHTML;
            document.body.appendChild(container);
            modalResultados = document.getElementById('resultadoFiltroModal');
        } else {
            document.getElementById('mensagemResultadoFiltro').innerHTML = `Filtro aplicado: <b>${quantidade}</b> notas encontradas.`;
        }
        
        // Exibir modal com resultados
        const modal = new bootstrap.Modal(modalResultados);
        modal.show();
        
        // Também exibir uma mensagem na interface para ficar sempre visível
        const filtroStatusDiv = document.createElement('div');
        filtroStatusDiv.id = 'filtroAplicadoStatus';
        filtroStatusDiv.className = 'alert alert-info mb-3';
        filtroStatusDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-filter"></i> Filtro aplicado: <b>${quantidade}</b> notas encontradas.
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="limparFiltros()">Limpar Filtros</button>
            </div>
        `;
        
        // Remover status anterior se existir
        const statusAnterior = document.getElementById('filtroAplicadoStatus');
        if (statusAnterior) {
            statusAnterior.remove();
        }
        
        // Inserir novo status após card de filtros
        const cardFiltros = document.querySelector('#fiscal .card:first-child');
        cardFiltros.after(filtroStatusDiv);
    }

    // Função para limpar todos os filtros
    window.limparFiltros = function() {
        console.log("Limpando filtros...");
        
        // Marcar "Qualquer data"
        document.getElementById('qualquerData').checked = true;
        
        // Limpar/desabilitar campos de data
        const dataInicio = document.getElementById('filtroDataInicio');
        const dataFim = document.getElementById('filtroDataFim');
        dataInicio.value = '';
        dataFim.value = '';
        dataInicio.disabled = true;
        dataFim.disabled = true;
        
        // Resetar tipo de documento
        document.getElementById('filtroTipoDoc').value = 'todos';
        
        // Limpar valor mínimo
        document.getElementById('filtroValorMinimo').value = '';
        
        // Limpar CFOPs
        document.getElementById('filtroCFOP').value = '';
        
        // Resetar seletor de emitentes
        const emitenteSelect = document.getElementById('filtroEmitente');
        Array.from(emitenteSelect.options).forEach(opt => {
            opt.selected = opt.value === 'todos';
        });
        
        // Limpar filtros de impostos aplicados
        document.getElementById('filtrosImpostosAplicados').innerHTML = '';
        
        // Remover status de filtro
        const filtroStatus = document.getElementById('filtroStatus');
        if (filtroStatus) {
            filtroStatus.remove();
        }
        
        // Recarregar todas as notas
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const todasNotas = event.target.result;
            console.log(`Filtros limpos: carregando todas as ${todasNotas.length} notas.`);
            atualizarDashboardComNotasFiltradas(todasNotas);
        };
    };

    // Função para atualizar o seletor de emitentes
    function atualizarSeletorEmitentes(notas, seletor, valorAtual) {
        // Salvar o valor selecionado atualmente
        const valorSelecionado = valorAtual || seletor.value;
        
        // Limpar seletor
        seletor.innerHTML = '<option value="todos">Todos os Emitentes</option>';
        
        // Coletar emitentes únicos
        const emitentes = {};
        notas.forEach(nota => {
            if (nota.emitente && nota.emitente.nome) {
                emitentes[nota.emitente.cnpj] = nota.emitente.nome;
            }
        });
        
        // Adicionar emitentes ao seletor
        Object.entries(emitentes).forEach(([cnpj, nome]) => {
            const option = document.createElement('option');
            option.value = cnpj;
            option.textContent = nome;
            option.selected = cnpj === valorSelecionado;
            seletor.appendChild(option);
        });
        
        // Se o valor selecionado não existir mais, selecionar "todos"
        if (valorSelecionado !== 'todos' && !emitentes[valorSelecionado]) {
            seletor.value = 'todos';
        }
    }

    // Modificar a função de inicialização de eventos
    function inicializarEventosFiltros() {
        // Botão para adicionar filtro de imposto
        document.getElementById('btnAdicionarFiltroImposto').addEventListener('click', function() {
            const tipoImposto = document.getElementById('filtroTipoImposto').value;
            const comparacao = document.getElementById('filtroComparacao').value;
            const valorImposto = document.getElementById('filtroValorImposto').value;
            
            if (!tipoImposto || !valorImposto) {
                alert('Selecione o tipo de imposto e informe um valor.');
                return;
            }
            
            const filtroId = 'filtro_' + Date.now();
            const filtroHTML = `
                <div id="${filtroId}" class="badge bg-info text-dark p-2 me-2 mb-1">
                    ${tipoImposto} ${comparacao} R$ ${valorImposto}
                    <span class="ms-1 cursor-pointer" onclick="removerFiltroImposto('${filtroId}')" style="cursor:pointer;">×</span>
                    <input type="hidden" class="filtro-imposto-config" 
                           data-tipo="${tipoImposto}" 
                           data-comparacao="${comparacao}" 
                           data-valor="${valorImposto}">
                </div>
            `;
            
            document.getElementById('filtrosImpostosAplicados').insertAdjacentHTML('beforeend', filtroHTML);
            
            // Limpar campos
            document.getElementById('filtroTipoImposto').value = '';
            document.getElementById('filtroValorImposto').value = '';
        });
        
        // Botão para aplicar filtros - usar o evento submit para permitir pressionar Enter
        document.getElementById('btnAplicarFiltros').addEventListener('click', function(e) {
            e.preventDefault();
            console.log("Aplicando filtros...");
            aplicarFiltrosAvancados();
        });
        
        // Botão para salvar filtro
        document.getElementById('btnSalvarFiltro').addEventListener('click', function() {
            salvarFiltroAtual();
        });
        
        // Botão para gerenciar filtros
        document.getElementById('btnGerenciarFiltros').addEventListener('click', function() {
            mostrarGerenciadorFiltros();
        });
        
        // Adicionar evento para filtrar ao pressionar Enter nos campos de filtro
        const camposFiltro = document.querySelectorAll('#fiscal input, #fiscal select');
        camposFiltro.forEach(campo => {
            campo.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    aplicarFiltrosAvancados();
                }
            });
        });
    }

    // Remover filtro de imposto
    window.removerFiltroImposto = function(filtroId) {
        const filtro = document.getElementById(filtroId);
        if (filtro) {
            filtro.remove();
        }
    };

    // Função para salvar o filtro atual
    function salvarFiltroAtual() {
        const nomeFiltro = prompt("Digite um nome para salvar este filtro:");
        
        if (!nomeFiltro) return;
        
        // Obter configuração atual dos filtros
        const configuracao = {
            nome: nomeFiltro,
            dataInicio: document.getElementById('filtroDataInicio').value,
            dataFim: document.getElementById('filtroDataFim').value,
            emitentes: Array.from(document.getElementById('filtroEmitente').selectedOptions).map(opt => opt.value),
            tipoDoc: document.getElementById('filtroTipoDoc').value,
            valorMinimo: document.getElementById('filtroValorMinimo').value,
            cfop: document.getElementById('filtroCFOP').value,
            filtrosImpostos: Array.from(document.querySelectorAll('.filtro-imposto-config')).map(input => ({
                tipo: input.dataset.tipo,
                comparacao: input.dataset.comparacao,
                valor: input.dataset.valor
            }))
        };
        
        // Salvar no localStorage
        const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosFiscais') || '[]');
        filtrosSalvos.push(configuracao);
        localStorage.setItem('filtrosFiscais', JSON.stringify(filtrosSalvos));
        
        alert(`Filtro "${nomeFiltro}" salvo com sucesso!`);
    }

    // Função para mostrar o gerenciador de filtros
    function mostrarGerenciadorFiltros() {
        // Recuperar filtros salvos
        const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosFiscais') || '[]');
        
        if (filtrosSalvos.length === 0) {
            alert("Não há filtros salvos.");
            return;
        }
        
        // Criar modal para gerenciar filtros
        const modalHTML = `
            <div class="modal fade" id="gerenciadorFiltrosModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Gerenciar Filtros Salvos</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Período</th>
                                            <th>Emitentes</th>
                                            <th>Tipo</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaFiltrosSalvos">
                                        ${filtrosSalvos.map((filtro, index) => `
                                            <tr>
                                                <td>${filtro.nome}</td>
                                                <td>${filtro.dataInicio} a ${filtro.dataFim}</td>
                                                <td>${filtro.emitentes.includes('todos') ? 'Todos' : 'Específicos'}</td>
                                                <td>${filtro.tipoDoc}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" onclick="aplicarFiltroSalvo(${index})">Aplicar</button>
                                                    <button class="btn btn-sm btn-danger" onclick="excluirFiltroSalvo(${index})">Excluir</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar o modal ao DOM se ainda não existir
        if (!document.getElementById('gerenciadorFiltrosModal')) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
        } else {
            // Atualizar a tabela de filtros no modal existente
            const tbody = document.getElementById('tabelaFiltrosSalvos');
            tbody.innerHTML = filtrosSalvos.map((filtro, index) => `
                <tr>
                    <td>${filtro.nome}</td>
                    <td>${filtro.dataInicio} a ${filtro.dataFim}</td>
                    <td>${filtro.emitentes.includes('todos') ? 'Todos' : 'Específicos'}</td>
                    <td>${filtro.tipoDoc}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="aplicarFiltroSalvo(${index})">Aplicar</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirFiltroSalvo(${index})">Excluir</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Mostrar o modal
        const modal = new bootstrap.Modal(document.getElementById('gerenciadorFiltrosModal'));
        modal.show();
    }

    // Função para aplicar um filtro salvo
    window.aplicarFiltroSalvo = function(index) {
        const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosFiscais') || '[]');
        
        if (index < 0 || index >= filtrosSalvos.length) {
            alert("Filtro não encontrado.");
            return;
        }
        
        const filtro = filtrosSalvos[index];
        
        // Preencher os campos com as configurações do filtro
        document.getElementById('filtroDataInicio').value = filtro.dataInicio;
        document.getElementById('filtroDataFim').value = filtro.dataFim;
        document.getElementById('filtroTipoDoc').value = filtro.tipoDoc;
        document.getElementById('filtroValorMinimo').value = filtro.valorMinimo;
        document.getElementById('filtroCFOP').value = filtro.cfop;
        
        // Selecionar emitentes
        const emitenteSelect = document.getElementById('filtroEmitente');
        Array.from(emitenteSelect.options).forEach(option => {
            option.selected = filtro.emitentes.includes(option.value);
        });
        
        if (typeof $ !== 'undefined' && typeof $.fn.select2 !== 'undefined') {
            $('#filtroEmitente').trigger('change');
        }
        
        // Limpar e adicionar filtros de impostos
        document.getElementById('filtrosImpostosAplicados').innerHTML = '';
        
        filtro.filtrosImpostos.forEach(fi => {
            const filtroId = 'filtro_' + Date.now() + Math.floor(Math.random() * 1000);
            const filtroHTML = `
                <div id="${filtroId}" class="badge bg-info text-dark p-2 me-2 mb-1">
                    ${fi.tipo} ${fi.comparacao} R$ ${fi.valor}
                    <span class="ms-1 cursor-pointer" onclick="removerFiltroImposto('${filtroId}')" style="cursor:pointer;">×</span>
                    <input type="hidden" class="filtro-imposto-config" 
                           data-tipo="${fi.tipo}" 
                           data-comparacao="${fi.comparacao}" 
                           data-valor="${fi.valor}">
                </div>
            `;
            
            document.getElementById('filtrosImpostosAplicados').insertAdjacentHTML('beforeend', filtroHTML);
        });
        
        // Fechar o modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('gerenciadorFiltrosModal'));
        modal.hide();
        
        // Aplicar o filtro
        aplicarFiltrosAvancados();
    };

    // Função para excluir um filtro salvo
    window.excluirFiltroSalvo = function(index) {
        if (!confirm("Tem certeza que deseja excluir este filtro?")) return;
        
        const filtrosSalvos = JSON.parse(localStorage.getItem('filtrosFiscais') || '[]');
        
        if (index < 0 || index >= filtrosSalvos.length) {
            alert("Filtro não encontrado.");
            return;
        }
        
        // Remover o filtro
        filtrosSalvos.splice(index, 1);
        localStorage.setItem('filtrosFiscais', JSON.stringify(filtrosSalvos));
        
        // Atualizar a exibição
        mostrarGerenciadorFiltros();
    };

    // Modificar a função atualizarDashboardFiscal para incluir os filtros
    function atualizarDashboardFiscal(notas) {
        // Adicionar filtros avançados se ainda não existirem
        if (!document.getElementById('btnAplicarFiltros')) {
            adicionarFiltrosAvancados();
        }
        
        // Preencher o seletor de emitentes
        carregarEmitentesParaFiltro(notas);
        
        // Preencher o seletor comum de emitentes (que já existia)
        const seletorEmitente = document.getElementById('seletorEmitenteImposto');
        seletorEmitente.innerHTML = '<option value="todos">Todos os Emitentes</option>';
        
        // Coletar todos os emitentes únicos
        const emitentes = {};
        notas.forEach(nota => {
            if (nota.emitente && nota.emitente.nome) {
                emitentes[nota.emitente.cnpj] = nota.emitente.nome;
            }
        });
        
        // Adicionar emitentes ao seletor
        Object.entries(emitentes).forEach(([cnpj, nome]) => {
            seletorEmitente.innerHTML += `<option value="${cnpj}">${nome}</option>`;
        });
        
        // Extrair dados de impostos de todas as notas
        const dadosImpostos = extrairDadosImpostos(notas);
        
        // Mostrar resumo de impostos
        mostrarResumoImpostos(dadosImpostos);
        
        // Gerar gráficos
        gerarGraficoImpostosPorTipo(dadosImpostos);
        gerarGraficoCFOPs(notas);
        
        // Preencher tabela detalhada de impostos
        preencherTabelaImpostosDetalhados(dadosImpostos);
        
        // Verificar conformidade
        verificarConformidade(notas);
        
        // Adicionar evento de filtro de emitente (seletor comum)
        seletorEmitente.addEventListener('change', function() {
            const emitenteSelecionado = this.value;
            
            // Filtrar notas pelo emitente selecionado
            const notasFiltradas = emitenteSelecionado === 'todos' ? 
                notas : 
                notas.filter(nota => nota.emitente && nota.emitente.cnpj === emitenteSelecionado);
            
            // Atualizar dados com o filtro aplicado
            const dadosImpostosFiltrados = extrairDadosImpostos(notasFiltradas);
            mostrarResumoImpostos(dadosImpostosFiltrados);
            gerarGraficoImpostosPorTipo(dadosImpostosFiltrados);
            preencherTabelaImpostosDetalhados(dadosImpostosFiltrados);
        });
        
        // Adicionar evento de filtro de tipo de imposto
        document.getElementById('filtroTipoImpostoDetalhado').addEventListener('change', function() {
            const tipoImposto = this.value;
            
            // Filtrar impostos pelo tipo selecionado
            let impostosFiltrados = dadosImpostos.impostosPorItem;
            
            if (tipoImposto !== 'todos') {
                impostosFiltrados = impostosFiltrados.filter(imp => imp.tipo === tipoImposto);
            }
            
            // Atualizar tabela com filtro aplicado
            preencherTabelaImpostosDetalhadosComDados(impostosFiltrados, dadosImpostos.notasPorId);
        });
    }

    // Função corrigida para inicializar gráficos com segurança
    function inicializarGraficos() {
        console.log("Inicializando gráficos com segurança...");
        
        // Adicionar pequeno atraso para garantir que o DOM esteja pronto
        setTimeout(() => {
            try {
                // 1. Verificar e inicializar gráfico de impostos por tipo
                const ctxImpostos = document.getElementById('impostosPorTipoChart');
                if (ctxImpostos) {
                    // Verificar se o elemento está visível
                    if (ctxImpostos.offsetParent === null) {
                        console.log("Elemento 'impostosPorTipoChart' não está visível. Adiando inicialização.");
                        return; // Adiar inicialização até que esteja visível
                    }
                    
                    // Resetar o canvas para evitar problemas de contexto
                    ctxImpostos.getContext('2d').clearRect(0, 0, ctxImpostos.width, ctxImpostos.height);
                    
                    // Verificar e destruir gráfico existente
                    if (window.impostosPorTipoChart instanceof Chart) {
                        window.impostosPorTipoChart.destroy();
                        window.impostosPorTipoChart = null;
                    }
                    
                    // Criar novo gráfico com valores zero
                    window.impostosPorTipoChart = new Chart(ctxImpostos, {
                        type: 'bar',
                        data: {
                            labels: ['ICMS', 'IPI', 'PIS', 'COFINS', 'ISS'],
                            datasets: [{
                                label: 'Valor Total (R$)',
                                data: [0, 0, 0, 0, 0],
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(153, 102, 255, 0.7)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log("Gráfico de impostos inicializado com sucesso");
                }
                
                // 2. Verificar e inicializar gráfico de CFOPs
                const ctxCFOP = document.getElementById('cfopChart');
                if (ctxCFOP) {
                    // Verificar se o elemento está visível
                    if (ctxCFOP.offsetParent === null) {
                        console.log("Elemento 'cfopChart' não está visível. Adiando inicialização.");
                        return; // Adiar inicialização até que esteja visível
                    }
                    
                    // Resetar o canvas para evitar problemas de contexto
                    ctxCFOP.getContext('2d').clearRect(0, 0, ctxCFOP.width, ctxCFOP.height);
                    
                    // Verificar e destruir gráfico existente
                    if (window.cfopChart instanceof Chart) {
                        window.cfopChart.destroy();
                        window.cfopChart = null;
                    }
                    
                    // Criar novo gráfico com valores zero
                    window.cfopChart = new Chart(ctxCFOP, {
                        type: 'pie',
                        data: {
                            labels: ['Sem dados'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['rgba(200, 200, 200, 0.7)'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                    console.log("Gráfico de CFOPs inicializado com sucesso");
                }
            } catch (error) {
                console.error("Erro ao inicializar gráficos:", error);
            }
        }, 200); // Aguardar 200ms para garantir que o DOM esteja pronto
    }

    // Chamar esta função na inicialização da página
    document.addEventListener('DOMContentLoaded', function() {
        inicializarGraficos();
    });

    // Função para atualizar o gráfico de impostos por tipo
    function atualizarGraficoImpostosPorTipo(dadosImpostos) {
        // Verificar se o gráfico existe
        if (!window.impostosPorTipoChart) {
            console.warn("Gráfico de impostos por tipo não inicializado. Inicializando agora...");
            inicializarGraficos();
            return;
        }
        
        // Obter dados para o gráfico
        const valores = [
            parseFloat(dadosImpostos.resumoImpostos.ICMS.total || 0),
            parseFloat(dadosImpostos.resumoImpostos.IPI.total || 0),
            parseFloat(dadosImpostos.resumoImpostos.PIS.total || 0),
            parseFloat(dadosImpostos.resumoImpostos.COFINS.total || 0),
            parseFloat(dadosImpostos.resumoImpostos.ISS.total || 0)
        ];
        
        // Atualizar o dataset do gráfico
        window.impostosPorTipoChart.data.datasets[0].data = valores;
        
        // Atualizar o gráfico
        window.impostosPorTipoChart.update();
    }

    // Função para atualizar o gráfico de CFOPs
    function atualizarGraficoCFOPs(notas) {
        // Verificar se o gráfico existe
        if (!window.cfopChart) {
            console.warn("Gráfico de CFOPs não inicializado. Inicializando agora...");
            inicializarGraficos();
            return;
        }
        
        // Contar a frequência de cada CFOP
        const cfopContagem = {};
        notas.forEach(nota => {
            if (nota.cfop) {
                if (!cfopContagem[nota.cfop]) {
                    cfopContagem[nota.cfop] = 0;
                }
                cfopContagem[nota.cfop]++;
            }
        });
        
        // Ordenar CFOPs por frequência e pegar os 5 mais comuns
        const cfopOrdenados = Object.entries(cfopContagem)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        // Preparar dados para o gráfico
        if (cfopOrdenados.length > 0) {
            const labels = cfopOrdenados.map(([cfop]) => `CFOP ${cfop}`);
            const valores = cfopOrdenados.map(([_, contagem]) => contagem);
            
            // Atualizar o gráfico
            window.cfopChart.data.labels = labels;
            window.cfopChart.data.datasets[0].data = valores;
            window.cfopChart.data.datasets[0].backgroundColor = [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)'
            ];
        } else {
            // Sem dados
            window.cfopChart.data.labels = ['Sem dados'];
            window.cfopChart.data.datasets[0].data = [1];
            window.cfopChart.data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
        }
        
        // Atualizar o gráfico
        window.cfopChart.update();
    }

    // Inicializar os gráficos quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar o banco de dados
        inicializarDB().then(() => {
            console.log("Banco de dados inicializado");
            
            // Carregar dados iniciais (todas as notas)
            carregarDadosIniciais();
        });
        
        // Adicionar listener para a aba fiscal
        document.getElementById('fiscal-tab').addEventListener('click', function() {
            setTimeout(function() {
                if (!window.impostosPorTipoChart || !window.cfopChart) {
                    console.log("Inicializando gráficos ao mudar para a aba fiscal");
                    inicializarGraficos();
                }
            }, 300);
        });
    });

    // Carregar dados iniciais
    function carregarDadosIniciais() {
        if (!db) {
            console.warn("Banco de dados não inicializado");
            return;
        }
        
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notas = event.target.result;
            console.log(`Carregados ${notas.length} notas do banco de dados`);
            
            // Atualizar dashboard com todas as notas
            if (notas.length > 0) {
                atualizarDashboardComNotasFiltradas(notas);
            } else {
                // Mostrar mensagem de nenhum dado
                document.getElementById('resumoImpostosEmitente').innerHTML = 
                    '<div class="alert alert-info">Nenhuma nota fiscal encontrada. Use o botão "Extrair Dados" para importar XMLs.</div>';
            }
        };
        
        request.onerror = function(event) {
            console.error("Erro ao carregar notas iniciais:", event.target.error);
        };
    }

    // Função auxiliar para atualizar os gráficos
    function atualizarGraficos(dadosImpostos, notasFiltradas) {
        try {
            // 1. Verificar se o gráfico de impostos existe e está inicializado
            if (!window.impostosPorTipoChart) {
                inicializarGraficos();
                setTimeout(() => atualizarGraficos(dadosImpostos, notasFiltradas), 200);
                return;
            }
            
            // 2. Atualizar dados do gráfico de impostos
            const valores = [
                parseFloat(dadosImpostos.resumoImpostos.ICMS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.IPI.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.PIS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.COFINS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.ISS.total || 0)
            ];
            
            window.impostosPorTipoChart.data.datasets[0].data = valores;
            window.impostosPorTipoChart.update();
            
            // 3. Atualizar o gráfico de CFOPs
            if (!window.cfopChart) {
                setTimeout(() => atualizarGraficos(dadosImpostos, notasFiltradas), 200);
                return;
            }
            
            // Contar CFOPs
            const cfopContagem = {};
            notasFiltradas.forEach(nota => {
                if (nota.cfop) {
                    cfopContagem[nota.cfop] = (cfopContagem[nota.cfop] || 0) + 1;
                }
            });
            
            // Preparar dados para o gráfico
            const cfopTop5 = Object.entries(cfopContagem)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (cfopTop5.length > 0) {
                window.cfopChart.data.labels = cfopTop5.map(([cfop]) => `CFOP ${cfop}`);
                window.cfopChart.data.datasets[0].data = cfopTop5.map(([_, count]) => count);
                window.cfopChart.data.datasets[0].backgroundColor = [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)'
                ];
            } else {
                window.cfopChart.data.labels = ['Sem dados'];
                window.cfopChart.data.datasets[0].data = [1];
                window.cfopChart.data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
            }
            
            window.cfopChart.update();
            console.log("Gráficos atualizados com sucesso");
            
        } catch (error) {
            console.error("Erro ao atualizar gráficos:", error);
        }
    }

    // Melhor inicialização na carga da página
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar DB
        inicializarDB().then(() => {
            console.log("Banco de dados inicializado");
            
            // Carregar dados iniciais
            setTimeout(carregarDadosIniciais, 300);
            
            // Adicionar listener para a mudança de aba
            const fiscalTab = document.getElementById('fiscal-tab');
            if (fiscalTab) {
                fiscalTab.addEventListener('shown.bs.tab', function() {
                    console.log("Aba fiscal ativada");
                    setTimeout(inicializarGraficos, 200);
                });
            }
        }).catch(err => {
            console.error("Erro ao inicializar DB:", err);
        });
    });

    // Função simplificada para inicializar os gráficos
    function inicializarGraficosFiscais() {
        console.log("Inicializando gráficos fiscais de forma direta...");
        
        // Destruir gráficos existentes para evitar erros
        if (window.impostosPorTipoChart instanceof Chart) {
            window.impostosPorTipoChart.destroy();
            window.impostosPorTipoChart = null;
        }
        
        if (window.cfopChart instanceof Chart) {
            window.cfopChart.destroy();
            window.cfopChart = null;
        }
        
        // Criar o gráfico de impostos por tipo com dados vazios
        const ctxImpostos = document.getElementById('impostosPorTipoChart');
        if (ctxImpostos) {
            window.impostosPorTipoChart = new Chart(ctxImpostos, {
                type: 'bar',
                data: {
                    labels: ['ICMS', 'IPI', 'PIS', 'COFINS', 'ISS'],
                    datasets: [{
                        label: 'Valor Total (R$)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(30, 144, 255, 0.7)',  // DodgerBlue
                            'rgba(46, 139, 87, 0.7)',   // SeaGreen
                            'rgba(255, 105, 180, 0.7)', // HotPink
                            'rgba(255, 165, 0, 0.7)',   // Orange
                            'rgba(128, 128, 128, 0.7)'  // Gray
                        ]
                    }]
                },
                options: {
                    animation: false, // Desabilitar animação para melhor performance
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Criar o gráfico de CFOPs com dados vazios
        const ctxCFOP = document.getElementById('cfopChart');
        if (ctxCFOP) {
            window.cfopChart = new Chart(ctxCFOP, {
                type: 'pie',
                data: {
                    labels: ['Sem dados'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['rgba(200, 200, 200, 0.7)']
                    }]
                },
                options: {
                    animation: false, // Desabilitar animação para melhor performance
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        console.log("Gráficos fiscais inicializados com sucesso");
    }

    // Função para atualizar os dados dos gráficos
    function atualizarDadosGraficosFiscais(dadosImpostos, notasFiltradas) {
        console.log("Atualizando dados dos gráficos fiscais...");
        
        // Se não existirem gráficos, inicializá-los
        if (!window.impostosPorTipoChart || !window.cfopChart) {
            inicializarGraficosFiscais();
        }
        
        // Atualizar gráfico de impostos
        if (window.impostosPorTipoChart) {
            const valores = [
                Number(dadosImpostos.resumoImpostos.ICMS.total || 0),
                Number(dadosImpostos.resumoImpostos.IPI.total || 0),
                Number(dadosImpostos.resumoImpostos.PIS.total || 0),
                Number(dadosImpostos.resumoImpostos.COFINS.total || 0),
                Number(dadosImpostos.resumoImpostos.ISS.total || 0)
            ];
            
            window.impostosPorTipoChart.data.datasets[0].data = valores;
            window.impostosPorTipoChart.update();
        }
        
        // Atualizar gráfico de CFOPs
        if (window.cfopChart) {
            // Contar CFOPs nas notas
            const cfopCount = {};
            
            if (notasFiltradas && notasFiltradas.length > 0) {
                notasFiltradas.forEach(nota => {
                    if (nota.cfop) {
                        cfopCount[nota.cfop] = (cfopCount[nota.cfop] || 0) + 1;
                    }
                });
                
                // Ordenar e pegar os 5 principais
                const cfopData = Object.entries(cfopCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (cfopData.length > 0) {
                    window.cfopChart.data.labels = cfopData.map(item => `CFOP ${item[0]}`);
                    window.cfopChart.data.datasets[0].data = cfopData.map(item => item[1]);
                    window.cfopChart.data.datasets[0].backgroundColor = [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ];
                    window.cfopChart.update();
                    return;
                }
            }
            
            // Caso não haja dados
            window.cfopChart.data.labels = ['Sem dados'];
            window.cfopChart.data.datasets[0].data = [1];
            window.cfopChart.data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
            window.cfopChart.update();
        }
    }

    // Adicionar uma nova aba para exportação de dados
    function adicionarAbaExportacao() {
        // Adicionar uma nova aba no menu de navegação
        const navTabs = document.getElementById('myTab');
        const exportacaoTab = document.createElement('li');
        exportacaoTab.className = 'nav-item';
        exportacaoTab.setAttribute('role', 'presentation');
        exportacaoTab.innerHTML = `
            <button class="nav-link" id="exportacao-tab" data-bs-toggle="tab" data-bs-target="#exportacao" type="button" role="tab">Exportação</button>
        `;
        navTabs.appendChild(exportacaoTab);

        // Adicionar o conteúdo da nova aba
        const tabContent = document.getElementById('myTabContent');
        const exportacaoContent = document.createElement('div');
        exportacaoContent.className = 'tab-pane fade';
        exportacaoContent.id = 'exportacao';
        exportacaoContent.setAttribute('role', 'tabpanel');

        exportacaoContent.innerHTML = `
            <div class="mt-4">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Exportação Personalizada de Dados</span>
                        <button id="btnExportarCSV" class="btn btn-success">Exportar CSV</button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-5">
                                <div class="card h-100">
                                    <div class="card-header">Campos Disponíveis</div>
                                    <div class="card-body">
                                        <div class="list-group" id="camposDisponiveis">
                                            <!-- Os campos disponíveis serão inseridos dinamicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex align-items-center justify-content-center">
                                <div class="d-grid gap-2">
                                    <button id="btnAdicionarCampo" class="btn btn-primary">&rarr;</button>
                                    <button id="btnRemoverCampo" class="btn btn-outline-danger">&larr;</button>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="card h-100">
                                    <div class="card-header">Campos Selecionados</div>
                                    <div class="card-body">
                                        <div class="list-group" id="camposSelecionados">
                                            <!-- Os campos selecionados serão inseridos dinamicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">Organizar Ordem dos Campos</div>
                                    <div class="card-body">
                                        <div class="btn-group">
                                            <button id="btnMoverCima" class="btn btn-outline-secondary">&uarr; Mover para Cima</button>
                                            <button id="btnMoverBaixo" class="btn btn-outline-secondary">&darr; Mover para Baixo</button>
                                        </div>
                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="incluirCabecalhos" checked>
                                            <label class="form-check-label" for="incluirCabecalhos">
                                                Incluir cabeçalhos no CSV
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Modelos Salvos</div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" id="nomeModeloExportacao" class="form-control" placeholder="Nome do modelo">
                            </div>
                            <div class="col-md-2">
                                <button id="btnSalvarModelo" class="btn btn-primary">Salvar Modelo</button>
                            </div>
                            <div class="col-md-4">
                                <select id="modelosSalvos" class="form-select">
                                    <option value="">Selecione um modelo salvo</option>
                                    <!-- Os modelos salvos serão inseridos dinamicamente -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button id="btnCarregarModelo" class="btn btn-outline-secondary">Carregar</button>
                            </div>
                        </div>
                        <div id="listaModelosSalvos"></div>
                    </div>
                </div>
            </div>
        `;

        tabContent.appendChild(exportacaoContent);
        
        // Inicializar a funcionalidade de exportação
        inicializarExportacao();
    }

    // Inicializar a funcionalidade de exportação CSV
    function inicializarExportacao() {
        // Definir todos os campos disponíveis para exportação
        const camposDisponiveis = [
            { id: 'tipo', nome: 'Tipo de Documento' },
            { id: 'numero', nome: 'Número da Nota' },
            { id: 'data', nome: 'Data de Emissão' },
            { id: 'valor', nome: 'Valor Total' },
            { id: 'emitente.nome', nome: 'Nome do Emitente' },
            { id: 'emitente.cnpj', nome: 'CNPJ do Emitente' },
            { id: 'destinatario.nome', nome: 'Nome do Destinatário' },
            { id: 'destinatario.cnpj', nome: 'CNPJ do Destinatário' },
            { id: 'cfop', nome: 'CFOP' },
            { id: 'impostosTotais.valorICMS', nome: 'Valor ICMS' },
            { id: 'impostosTotais.baseCalculoICMS', nome: 'Base de Cálculo ICMS' },
            { id: 'impostosTotais.valorIPI', nome: 'Valor IPI' },
            { id: 'impostosTotais.valorPIS', nome: 'Valor PIS' },
            { id: 'impostosTotais.valorCOFINS', nome: 'Valor COFINS' },
            { id: 'impostosTotais.valorISS', nome: 'Valor ISS' }
        ];
        
        // Renderizar os campos disponíveis
        const camposDisponiveisEl = document.getElementById('camposDisponiveis');
        camposDisponiveisEl.innerHTML = '';
        
        camposDisponiveis.forEach(campo => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.dataset.id = campo.id;
            item.textContent = campo.nome;
            camposDisponiveisEl.appendChild(item);
        });
        
        // Adicionar eventos para os botões
        document.getElementById('btnAdicionarCampo').addEventListener('click', adicionarCampoSelecionado);
        document.getElementById('btnRemoverCampo').addEventListener('click', removerCampoSelecionado);
        document.getElementById('btnMoverCima').addEventListener('click', moverCampoParaCima);
        document.getElementById('btnMoverBaixo').addEventListener('click', moverCampoParaBaixo);
        document.getElementById('btnExportarCSV').addEventListener('click', exportarCSV);
        document.getElementById('btnSalvarModelo').addEventListener('click', salvarModeloExportacao);
        document.getElementById('btnCarregarModelo').addEventListener('click', carregarModeloExportacao);
        
        // Adicionar eventos de seleção para os campos
        const itemsCamposDisponiveis = camposDisponiveisEl.getElementsByClassName('list-group-item');
        for (let item of itemsCamposDisponiveis) {
            item.addEventListener('click', function() {
                toggleSelecaoCampo(this);
            });
        }
        
        // Carregar modelos salvos
        carregarModelosSalvos();
    }

    // Função para alternar a seleção de um campo
    function toggleSelecaoCampo(elemento) {
        // Remover a seleção atual
        const container = elemento.parentElement;
        const itens = container.getElementsByClassName('list-group-item');
        for (let item of itens) {
            item.classList.remove('active');
        }
        
        // Selecionar o elemento clicado
        elemento.classList.add('active');
    }

    // Função para adicionar um campo selecionado
    function adicionarCampoSelecionado() {
        const camposDisponiveis = document.getElementById('camposDisponiveis');
        const camposSelecionados = document.getElementById('camposSelecionados');
        
        const campoSelecionado = camposDisponiveis.querySelector('.active');
        if (!campoSelecionado) {
            alert('Selecione um campo para adicionar');
            return;
        }
        
        // Verificar se o campo já foi adicionado
        const campoId = campoSelecionado.dataset.id;
        if (camposSelecionados.querySelector(`[data-id="${campoId}"]`)) {
            alert('Este campo já foi adicionado');
            return;
        }
        
        // Adicionar o campo à lista de selecionados
        const novoCampo = document.createElement('a');
        novoCampo.href = '#';
        novoCampo.className = 'list-group-item list-group-item-action';
        novoCampo.dataset.id = campoId;
        novoCampo.textContent = campoSelecionado.textContent;
        
        camposSelecionados.appendChild(novoCampo);
        
        // Adicionar evento de clique para seleção
        novoCampo.addEventListener('click', function() {
            toggleSelecaoCampo(this);
        });
        
        // Limpar seleção
        campoSelecionado.classList.remove('active');
    }

    // Função para remover um campo selecionado
    function removerCampoSelecionado() {
        const camposSelecionados = document.getElementById('camposSelecionados');
        const campoSelecionado = camposSelecionados.querySelector('.active');
        
        if (!campoSelecionado) {
            alert('Selecione um campo para remover');
            return;
        }
        
        camposSelecionados.removeChild(campoSelecionado);
    }

    // Função para mover um campo para cima na ordem
    function moverCampoParaCima() {
        const camposSelecionados = document.getElementById('camposSelecionados');
        const campoSelecionado = camposSelecionados.querySelector('.active');
        
        if (!campoSelecionado) {
            alert('Selecione um campo para mover');
            return;
        }
        
        const campoAnterior = campoSelecionado.previousElementSibling;
        if (campoAnterior) {
            camposSelecionados.insertBefore(campoSelecionado, campoAnterior);
        }
    }

    // Função para mover um campo para baixo na ordem
    function moverCampoParaBaixo() {
        const camposSelecionados = document.getElementById('camposSelecionados');
        const campoSelecionado = camposSelecionados.querySelector('.active');
        
        if (!campoSelecionado) {
            alert('Selecione um campo para mover');
            return;
        }
        
        const campoProximo = campoSelecionado.nextElementSibling;
        if (campoProximo) {
            camposSelecionados.insertBefore(campoProximo, campoSelecionado);
        }
    }

    // Função para exportar dados em CSV
    function exportarCSV() {
        const camposSelecionados = document.getElementById('camposSelecionados');
        const campos = camposSelecionados.querySelectorAll('.list-group-item');
        
        if (campos.length === 0) {
            alert('Selecione pelo menos um campo para exportar');
            return;
        }
        
        // Obter todos os campos selecionados
        const camposParaExportar = [];
        campos.forEach(campo => {
            camposParaExportar.push({
                id: campo.dataset.id,
                nome: campo.textContent
            });
        });
        
        // Obter dados do banco de dados
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notas = event.target.result;
            
            if (notas.length === 0) {
                alert('Não há dados para exportar');
                return;
            }
            
            // Criar CSV
            let csv = '';
            
            // Adicionar cabeçalhos se solicitado
            const incluirCabecalhos = document.getElementById('incluirCabecalhos').checked;
            if (incluirCabecalhos) {
                csv += camposParaExportar.map(campo => `"${campo.nome}"`).join(',') + '\n';
            }
            
            // Adicionar dados
            notas.forEach(nota => {
                const linha = camposParaExportar.map(campo => {
                    // Lidar com campos aninhados (como emitente.nome)
                    const partes = campo.id.split('.');
                    let valor = nota;
                    for (const parte of partes) {
                        if (valor && valor[parte] !== undefined) {
                            valor = valor[parte];
                        } else {
                            valor = '';
                            break;
                        }
                    }
                    
                    // Formatar o valor para CSV
                    if (valor === null || valor === undefined) valor = '';
                    return `"${String(valor).replace(/"/g, '""')}"`;
                });
                
                csv += linha.join(',') + '\n';
            });
            
            // Criar blob e download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const dataAtual = new Date().toLocaleDateString().replace(/\//g, '-');
            const nomeArquivo = `exportacao_notas_${dataAtual}.csv`;
            
            // Criar link para download
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', nomeArquivo);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Seu navegador não suporta download automático. O CSV foi gerado, mas você precisa salvá-lo manualmente.');
                console.log(csv);
            }
        };
        
        request.onerror = function(event) {
            console.error("Erro ao buscar dados para exportação:", event.target.error);
            alert("Ocorreu um erro ao buscar os dados para exportação.");
        };
    }

    // Função para salvar um modelo de exportação
    function salvarModeloExportacao() {
        const nomeModelo = document.getElementById('nomeModeloExportacao').value.trim();
        
        if (!nomeModelo) {
            alert('Digite um nome para o modelo');
            return;
        }
        
        const camposSelecionados = document.getElementById('camposSelecionados');
        const campos = camposSelecionados.querySelectorAll('.list-group-item');
        
        if (campos.length === 0) {
            alert('Selecione pelo menos um campo para salvar o modelo');
            return;
        }
        
        // Criar modelo
        const camposModelo = [];
        campos.forEach(campo => {
            camposModelo.push({
                id: campo.dataset.id,
                nome: campo.textContent
            });
        });
        
        // Salvar modelo no localStorage
        const modelosSalvos = JSON.parse(localStorage.getItem('modelosExportacao') || '{}');
        modelosSalvos[nomeModelo] = camposModelo;
        localStorage.setItem('modelosExportacao', JSON.stringify(modelosSalvos));
        
        // Limpar campo
        document.getElementById('nomeModeloExportacao').value = '';
        
        // Atualizar lista de modelos
        carregarModelosSalvos();
        
        alert(`Modelo "${nomeModelo}" salvo com sucesso!`);
    }

    // Função para carregar modelos salvos
    function carregarModelosSalvos() {
        const modelosSalvos = JSON.parse(localStorage.getItem('modelosExportacao') || '{}');
        const selectModelos = document.getElementById('modelosSalvos');
        const listaModelos = document.getElementById('listaModelosSalvos');
        
        // Limpar opções atuais, mantendo a primeira
        while (selectModelos.options.length > 1) {
            selectModelos.remove(1);
        }
        
        // Adicionar modelos ao select
        for (const nome in modelosSalvos) {
            const option = document.createElement('option');
            option.value = nome;
            option.textContent = nome;
            selectModelos.appendChild(option);
        }
        
        // Criar tabela de modelos salvos
        let html = '<table class="table table-striped mt-3">';
        html += '<thead><tr><th>Nome do Modelo</th><th>Campos</th><th>Ações</th></tr></thead><tbody>';
        
        for (const nome in modelosSalvos) {
            const campos = modelosSalvos[nome].map(c => c.nome).join(', ');
            html += `
                <tr>
                    <td>${nome}</td>
                    <td>${campos}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirModeloExportacao('${nome}')">Excluir</button>
                    </td>
                </tr>
            `;
        }
        
        html += '</tbody></table>';
        
        if (Object.keys(modelosSalvos).length === 0) {
            html = '<div class="alert alert-info mt-3">Nenhum modelo salvo</div>';
        }
        
        listaModelos.innerHTML = html;
    }

    // Função para carregar um modelo de exportação
    function carregarModeloExportacao() {
        const selectModelos = document.getElementById('modelosSalvos');
        const nomeModelo = selectModelos.value;
        
        if (!nomeModelo) {
            alert('Selecione um modelo para carregar');
            return;
        }
        
        const modelosSalvos = JSON.parse(localStorage.getItem('modelosExportacao') || '{}');
        const modelo = modelosSalvos[nomeModelo];
        
        if (!modelo) {
            alert('Modelo não encontrado');
            return;
        }
        
        // Limpar campos selecionados
        const camposSelecionados = document.getElementById('camposSelecionados');
        camposSelecionados.innerHTML = '';
        
        // Adicionar campos do modelo
        modelo.forEach(campo => {
            const novoCampo = document.createElement('a');
            novoCampo.href = '#';
            novoCampo.className = 'list-group-item list-group-item-action';
            novoCampo.dataset.id = campo.id;
            novoCampo.textContent = campo.nome;
            
            camposSelecionados.appendChild(novoCampo);
            
            // Adicionar evento de clique para seleção
            novoCampo.addEventListener('click', function() {
                toggleSelecaoCampo(this);
            });
        });
        
        alert(`Modelo "${nomeModelo}" carregado com sucesso!`);
    }

    // Função para excluir um modelo de exportação
    window.excluirModeloExportacao = function(nomeModelo) {
        if (confirm(`Tem certeza que deseja excluir o modelo "${nomeModelo}"?`)) {
            const modelosSalvos = JSON.parse(localStorage.getItem('modelosExportacao') || '{}');
            delete modelosSalvos[nomeModelo];
            localStorage.setItem('modelosExportacao', JSON.stringify(modelosSalvos));
            
            // Atualizar lista de modelos
            carregarModelosSalvos();
        }
    };

    // Chamar a função para adicionar a aba de exportação quando o documento estiver carregado
    document.addEventListener('DOMContentLoaded', function() {
        // Garantir que a função seja chamada após a inicialização do dashboard
        setTimeout(function() {
            adicionarAbaExportacao();
        }, 500);
    });

    // Melhorar a interface geral do dashboard
    function melhorarInterfaceDashboard() {
        // Adicionar ícones aos botões principais
        const botaoExtrair = document.querySelector('button[onclick="extractData()"]');
        if (botaoExtrair) {
            botaoExtrair.innerHTML = `<i class="fas fa-file-import"></i> Extrair Dados`;
            botaoExtrair.classList.add('btn-lg');
        }
        
        // Adicionar ícones às abas
        const abas = {
            'resumo-tab': '<i class="fas fa-chart-pie me-1"></i> Resumo',
            'destinatarios-tab': '<i class="fas fa-users me-1"></i> Por Destinatário',
            'tipos-tab': '<i class="fas fa-tags me-1"></i> Por Tipo',
            'fiscal-tab': '<i class="fas fa-file-invoice-dollar me-1"></i> Análise Fiscal',
            'dados-tab': '<i class="fas fa-table me-1"></i> Dados Completos',
            'exportacao-tab': '<i class="fas fa-file-export me-1"></i> Exportação'
        };
        
        for (const [id, html] of Object.entries(abas)) {
            const aba = document.getElementById(id);
            if (aba) {
                aba.innerHTML = html;
            }
        }
        
        // Adicionar sombra aos cards para melhorar a aparência
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.classList.add('shadow-sm');
        });
        
        // Adicionar feedback quando o usuário passar o mouse sobre cards clicáveis
        const cardsInterativos = document.querySelectorAll('.card-body');
        cardsInterativos.forEach(card => {
            card.style.transition = 'all 0.3s ease';
            card.addEventListener('mouseover', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            card.addEventListener('mouseout', function() {
                this.style.backgroundColor = '';
            });
        });
        
        // Melhorar a apresentação das estatísticas
        const estatisticasEl = document.getElementById('estatisticas');
        if (estatisticasEl) {
            const divs = estatisticasEl.querySelectorAll('div.bg-primary, div.bg-success, div.bg-info, div.bg-warning');
            divs.forEach(div => {
                div.classList.add('rounded', 'shadow-sm');
                const h3 = div.querySelector('h3');
                if (h3) {
                    h3.style.fontSize = '2rem';
                    h3.style.fontWeight = 'bold';
                }
            });
        }
        
        // Adicionar botão para alternar tema claro/escuro
        const navbar = document.querySelector('.container h1').parentNode;
        const btnTema = document.createElement('button');
        btnTema.className = 'btn btn-outline-secondary position-fixed bottom-0 end-0 m-3';
        btnTema.innerHTML = '<i class="fas fa-moon"></i>';
        btnTema.id = 'toggleTema';
        btnTema.addEventListener('click', alternarTema);
        document.body.appendChild(btnTema);
        
        // Verificar se há tema salvo
        const temaSalvo = localStorage.getItem('tema');
        if (temaSalvo === 'escuro') {
            document.body.classList.add('tema-escuro');
            atualizarIconeTema();
        }
    }

    // Função para alternar entre tema claro e escuro
    function alternarTema() {
        const body = document.body;
        body.classList.toggle('tema-escuro');
        
        // Salvar preferência
        const temaAtual = body.classList.contains('tema-escuro') ? 'escuro' : 'claro';
        localStorage.setItem('tema', temaAtual);
        
        atualizarIconeTema();
    }

    // Atualizar ícone do botão de tema
    function atualizarIconeTema() {
        const btnTema = document.getElementById('toggleTema');
        if (!btnTema) return;
        
        if (document.body.classList.contains('tema-escuro')) {
            btnTema.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            btnTema.innerHTML = '<i class="fas fa-moon"></i>';
        }
    }

    // Adicionar estilos para tema escuro
    function adicionarEstilosTema() {
        const style = document.createElement('style');
        style.textContent = `
            .tema-escuro {
                background-color: #222;
                color: #f0f0f0;
            }
            
            .tema-escuro .card {
                background-color: #333;
                color: #f0f0f0;
                border-color: #444;
            }
            
            .tema-escuro .card-header {
                background-color: #444;
                border-color: #555;
            }
            
            .tema-escuro .table {
                color: #f0f0f0;
            }
            
            .tema-escuro .table-striped tbody tr:nth-of-type(odd) {
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            .tema-escuro .nav-tabs {
                border-color: #444;
            }
            
            .tema-escuro .nav-tabs .nav-link {
                color: #aaa;
            }
            
            .tema-escuro .nav-tabs .nav-link.active {
                background-color: #333;
                color: #f0f0f0;
                border-color: #444 #444 #333;
            }
            
            .tema-escuro .form-control,
            .tema-escuro .form-select {
                background-color: #444;
                color: #f0f0f0;
                border-color: #555;
            }
            
            .tema-escuro .list-group-item {
                background-color: #333;
                color: #f0f0f0;
                border-color: #444;
            }
            
            .tema-escuro .list-group-item.active {
                background-color: #0d6efd;
                color: white;
            }
        `;
        
        document.head.appendChild(style);
    }

    // Chamar as funções para melhorar a interface
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar FontAwesome para ícones
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
        document.head.appendChild(fontAwesome);
        
        // Adicionar estilos para tema
        adicionarEstilosTema();
        
        // Melhorar a interface após um breve atraso para garantir que tudo esteja carregado
        setTimeout(function() {
            melhorarInterfaceDashboard();
        }, 700);
    });

    // Função para corrigir a renderização dos gráficos fiscais
    function corrigirGraficosFiscais() {
        console.log("Corrigindo gráficos da análise fiscal...");
        
        // Verificar se os elementos dos gráficos existem
        const impostosPorTipoElement = document.getElementById('impostosPorTipoChart');
        const cfopChartElement = document.getElementById('cfopChart');
        
        // Se não existirem, criar os elementos canvas
        if (!impostosPorTipoElement) {
            console.log("Criando canvas para gráfico de impostos por tipo");
            const container = document.querySelector('.card-body:has(.Total-de-Impostos-por-Tipo), .card-body:has(#Total-de-Impostos-por-Tipo)') || 
                              document.querySelector('[class*="card-body"]:first-of-type');
            
            if (container) {
                const canvas = document.createElement('canvas');
                canvas.id = 'impostosPorTipoChart';
                canvas.style.height = '300px';
                canvas.style.width = '100%';
                container.appendChild(canvas);
            }
        }
        
        if (!cfopChartElement) {
            console.log("Criando canvas para gráfico de CFOPs");
            const container = document.querySelector('.card-body:has(.Análise-de-CFOPs), .card-body:has(#Análise-de-CFOPs)') ||
                              document.querySelector('[class*="card-body"]:nth-of-type(2)');
            
            if (container) {
                const canvas = document.createElement('canvas');
                canvas.id = 'cfopChart';
                canvas.style.height = '300px';
                canvas.style.width = '100%';
                container.appendChild(canvas);
            }
        }
        
        // Inicializar os gráficos
        inicializarGraficosFiscais();
        
        // Recarregar dados para os gráficos
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notas = event.target.result;
            if (notas && notas.length > 0) {
                const dadosImpostos = extrairDadosImpostos(notas);
                atualizarDadosGraficosFiscais(dadosImpostos, notas);
            }
        };
    }

    // Função para inicializar os gráficos fiscais
    function inicializarGraficosFiscais() {
        console.log("Inicializando gráficos fiscais...");
        
        // Destruir gráficos existentes
        if (window.impostosPorTipoChart instanceof Chart) {
            window.impostosPorTipoChart.destroy();
        }
        
        if (window.cfopChart instanceof Chart) {
            window.cfopChart.destroy();
        }
        
        // Obter contextos dos canvas
        const ctxImpostos = document.getElementById('impostosPorTipoChart')?.getContext('2d');
        const ctxCFOP = document.getElementById('cfopChart')?.getContext('2d');
        
        // Criar gráfico de impostos por tipo
        if (ctxImpostos) {
            window.impostosPorTipoChart = new Chart(ctxImpostos, {
                type: 'bar',
                data: {
                    labels: ['ICMS', 'IPI', 'PIS', 'COFINS', 'ISS'],
                    datasets: [{
                        label: 'Valor Total (R$)',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // Criar gráfico de CFOPs
        if (ctxCFOP) {
            window.cfopChart = new Chart(ctxCFOP, {
                type: 'pie',
                data: {
                    labels: ['Sem dados'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['rgba(200, 200, 200, 0.7)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }

    // Atualizar dados dos gráficos
    function atualizarDadosGraficosFiscais(dadosImpostos, notas) {
        console.log("Atualizando dados dos gráficos fiscais");
        
        // Atualizar gráfico de impostos
        if (window.impostosPorTipoChart) {
            const valores = [
                parseFloat(dadosImpostos.resumoImpostos.ICMS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.IPI.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.PIS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.COFINS.total || 0),
                parseFloat(dadosImpostos.resumoImpostos.ISS.total || 0)
            ];
            
            window.impostosPorTipoChart.data.datasets[0].data = valores;
            window.impostosPorTipoChart.update();
        }
        
        // Atualizar gráfico de CFOPs
        if (window.cfopChart) {
            const cfopCount = {};
            notas.forEach(nota => {
                if (nota.cfop) {
                    cfopCount[nota.cfop] = (cfopCount[nota.cfop] || 0) + 1;
                }
            });
            
            const cfopData = Object.entries(cfopCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (cfopData.length > 0) {
                window.cfopChart.data.labels = cfopData.map(item => `CFOP ${item[0]}`);
                window.cfopChart.data.datasets[0].data = cfopData.map(item => item[1]);
                window.cfopChart.data.datasets[0].backgroundColor = [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)'
                ];
            } else {
                window.cfopChart.data.labels = ['Sem dados'];
                window.cfopChart.data.datasets[0].data = [1];
                window.cfopChart.data.datasets[0].backgroundColor = ['rgba(200, 200, 200, 0.7)'];
            }
            
            window.cfopChart.update();
        }
    }

    // Corrigir inicialização dos gráficos quando a aba fiscal for ativada
    document.addEventListener('DOMContentLoaded', function() {
        const fiscalTab = document.getElementById('fiscal-tab');
        if (fiscalTab) {
            fiscalTab.addEventListener('click', function() {
                // Esperar um pouco para garantir que a aba esteja visível
                setTimeout(corrigirGraficosFiscais, 300);
            });
        }
        
        // Tentar renderizar os gráficos ao carregar a página
        setTimeout(function() {
            // Verificar se a aba fiscal está ativa
            if (document.querySelector('#fiscal.active, #fiscal.show')) {
                corrigirGraficosFiscais();
            }
        }, 800);
    });

    // Função para corrigir a exibição de valores undefined na tabela
    function corrigirValoresUndefined() {
        console.log("Corrigindo valores undefined na tabela...");
        
        // Atualizar a função de preenchimento da tabela
        window.preencherTabelaImpostosDetalhados = function(dadosImpostos) {
            const tabela = document.getElementById('tabelaImpostosDetalhados');
            if (!tabela) return;
            
            // Verificar se há impostos detalhados
            if (!dadosImpostos || !dadosImpostos.impostosPorItem || dadosImpostos.impostosPorItem.length === 0) {
                tabela.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum dado de imposto encontrado</td></tr>';
                return;
            }
            
            // Formatar valores para exibição
            const formatarValor = (valor) => {
                if (valor === undefined || valor === null) return '-';
                return typeof valor === 'number' ? 
                       'R$ ' + valor.toFixed(2).replace('.', ',') : 
                       'R$ ' + parseFloat(valor || 0).toFixed(2).replace('.', ',');
            };
            
            // Preencher tabela com dados de impostos
            let html = '';
            dadosImpostos.impostosPorItem.forEach(imposto => {
                // Obter detalhes da nota
                const nota = dadosImpostos.notasPorId[imposto.notaId] || {};
                
                html += `
                    <tr>
                        <td>${imposto.notaId || '-'}</td>
                        <td>${nota.emitente?.nome || '-'}</td>
                        <td>${nota.data || '-'}</td>
                        <td>${imposto.tipo || '-'}</td>
                        <td>${formatarValor(imposto.baseCalculo)}</td>
                        <td>${imposto.aliquota !== undefined ? imposto.aliquota + '%' : '-'}</td>
                        <td>${formatarValor(imposto.valor)}</td>
                        <td>${imposto.cst || '-'}</td>
                    </tr>
                `;
            });
            
            tabela.innerHTML = html;
        };
        
        // Recarregar dados para a tabela
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const request = store.getAll();
        
        request.onsuccess = function(event) {
            const notas = event.target.result;
            if (notas && notas.length > 0) {
                const dadosImpostos = extrairDadosImpostos(notas);
                preencherTabelaImpostosDetalhados(dadosImpostos);
            }
        };
    }

    // Chamar função para corrigir valores undefined
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(corrigirValoresUndefined, 1000);
    });

    // Função para adicionar a chave da nota nos detalhes
    function melhorarDetalhesNota() {
        // Obter a função original de mostrar detalhes
        const funcaoOriginalMostrarDetalhes = window.mostrarDetalhesNota || null;
        
        // Sobrescrever a função para incluir a chave da nota
        window.mostrarDetalhesNota = function(nota) {
            // Chamar a função original primeiro, se existir
            if (funcaoOriginalMostrarDetalhes) {
                funcaoOriginalMostrarDetalhes(nota);
            }
            
            // Obter o modal ou criar um se não existir
            let modal = document.getElementById('detalhesModal');
            if (!modal) {
                console.warn("Modal de detalhes não encontrado, não é possível atualizar detalhes da nota");
                return;
            }
            
            // Verificar se o conteúdo do modal já inclui a chave
            if (modal.innerHTML.includes('Chave de Acesso')) {
                return; // Já foi adicionado
            }
            
            // Encontrar o elemento onde adicionar a chave
            const infoGerais = modal.querySelector('.modal-body div:first-child') || 
                               modal.querySelector('.modal-body');
            
            if (infoGerais) {
                // Criar o elemento para a chave
                const divChave = document.createElement('div');
                divChave.className = 'mb-2';
                
                // Adicionar o conteúdo da chave
                const chaveAcesso = nota.chaveAcesso || nota.chave || '-';
                divChave.innerHTML = `<strong>Chave de Acesso:</strong> ${chaveAcesso}`;
                
                // Adicionar após as informações do número da nota
                const elementoNumero = Array.from(infoGerais.querySelectorAll('div')).find(
                    div => div.textContent.includes('Número:')
                );
                
                if (elementoNumero) {
                    infoGerais.insertBefore(divChave, elementoNumero.nextSibling);
                } else {
                    // Se não encontrar o elemento número, adicionar ao final
                    infoGerais.appendChild(divChave);
                }
            }
        };
        
        // Adicionar a chave da nota nas opções de exportação
        const adicionarChaveNasOpcoesExportacao = function() {
            const camposDisponiveis = document.getElementById('camposDisponiveis');
            if (!camposDisponiveis) return;
            
            // Verificar se a opção já existe
            if (camposDisponiveis.querySelector('[data-id="chaveAcesso"]')) {
                return; // Já existe
            }
            
            // Criar o elemento da opção
            const itemChaveAcesso = document.createElement('a');
            itemChaveAcesso.href = '#';
            itemChaveAcesso.className = 'list-group-item list-group-item-action';
            itemChaveAcesso.dataset.id = 'chaveAcesso';
            itemChaveAcesso.textContent = 'Chave de Acesso da NF';
            
            // Adicionar ao início da lista para destaque
            camposDisponiveis.prepend(itemChaveAcesso);
            
            // Adicionar evento de clique
            itemChaveAcesso.addEventListener('click', function() {
                // Usar a mesma função de seleção dos outros campos
                if (typeof toggleSelecaoCampo === 'function') {
                    toggleSelecaoCampo(this);
                } else {
                    this.classList.toggle('active');
                }
            });
        };
        
        // Observador para detectar quando a aba de exportação for adicionada
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (document.getElementById('camposDisponiveis')) {
                    adicionarChaveNasOpcoesExportacao();
                    observer.disconnect();
                }
            });
        });
        
        // Iniciar observação
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Também tentar adicionar diretamente caso a aba já exista
        setTimeout(adicionarChaveNasOpcoesExportacao, 1000);
    }

    // Garantir que a função seja chamada quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        // Dar um tempo para o resto do app carregar
        setTimeout(melhorarDetalhesNota, 800);
    });

    // Função para garantir que a chave de acesso seja extraída do XML
    function melhorarExtracaoChaveNF() {
        console.log("Melhorando extração da chave de NF...");
        
        // Função original de extração
        const extractDataOriginal = window.extractData;
        
        // Sobrescrever a função de extração
        window.extractData = function() {
            console.log("Chamando função de extração com suporte à chave de NF");
            
            // Executar função original
            extractDataOriginal.apply(this, arguments);
            
            // Adicionar um hook após a extração para garantir que a chave seja armazenada
            setTimeout(function() {
                console.log("Verificando extração de chaves das notas...");
                
                const transaction = db.transaction(["notas"], "readwrite");
                const store = transaction.objectStore("notas");
                const request = store.getAll();
                
                request.onsuccess = function(event) {
                    const notas = event.target.result;
                    let notasAtualizadas = 0;
                    
                    notas.forEach(function(nota) {
                        // Verificar se a nota já tem a chave
                        if (!nota.chaveAcesso) {
                            // Tentar extrair a chave do XML original
                            if (nota.xmlOriginal) {
                                const parser = new DOMParser();
                                const xmlDoc = parser.parseFromString(nota.xmlOriginal, "text/xml");
                                
                                // Buscar a chave em diferentes lugares potenciais
                                const chaveNodes = [
                                    xmlDoc.querySelector('infNFe[Id]'),
                                    xmlDoc.querySelector('chNFe'),
                                    xmlDoc.querySelector('chave')
                                ];
                                
                                for (const node of chaveNodes) {
                                    if (node) {
                                        let chave = '';
                                        
                                        if (node.tagName === 'infNFe' && node.getAttribute('Id')) {
                                            chave = node.getAttribute('Id').replace('NFe', '');
                                        } else {
                                            chave = node.textContent;
                                        }
                                        
                                        if (chave && chave.length > 30) {
                                            nota.chaveAcesso = chave;
                                            notasAtualizadas++;
                                            
                                            // Atualizar nota no banco de dados
                                            store.put(nota);
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log(`Atualizadas ${notasAtualizadas} notas com chaves de acesso`);
                };
            }, 2000);
        };
    }

    // Função para corrigir a exibição da chave no modal de detalhes
    function corrigirExibicaoChaveNF() {
        console.log("Configurando observador para adicionar chave nos detalhes...");
        
        // Usar MutationObserver para detectar quando o modal de detalhes é exibido
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes && mutation.addedNodes.length) {
                    for (let i = 0; i < mutation.addedNodes.length; i++) {
                        const node = mutation.addedNodes[i];
                        
                        // Verificar se o modal foi adicionado
                        if (node.id === 'detalhesModal' || 
                            (node.classList && node.classList.contains('modal')) ||
                            node.querySelector('.modal')) {
                            
                            console.log("Modal de detalhes detectado!");
                            
                            // Tentar adicionar a chave
                            setTimeout(function() {
                                adicionarChaveAoModalDetalhe();
                            }, 100);
                        }
                    }
                }
            });
        });
        
        // Iniciar observação do body para detectar o modal
        observer.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
        
        // Tentar adicionar a chave caso o modal já esteja aberto
        if (document.querySelector('.modal.show')) {
            console.log("Modal já aberto, tentando adicionar chave...");
            adicionarChaveAoModalDetalhe();
        }
    }

    // Função para adicionar a chave ao modal já aberto
    function adicionarChaveAoModalDetalhe() {
        // Identificar o modal aberto
        const modal = document.querySelector('.modal.show, [role="dialog"].show, #detalhesModal');
        if (!modal) {
            console.log("Nenhum modal aberto encontrado");
            return;
        }
        
        // Verificar se já tem a chave
        if (modal.innerHTML.includes('Chave de Acesso:')) {
            console.log("Chave já adicionada ao modal");
            return;
        }
        
        console.log("Adicionando chave ao modal...");
        
        // Obter o número da nota do modal para identificar qual nota estamos exibindo
        const numeroTexto = modal.textContent.match(/Número:[\s]*([\d]+)/);
        if (!numeroTexto || !numeroTexto[1]) {
            console.log("Não foi possível identificar o número da nota no modal");
            return;
        }
        
        const numeroNota = numeroTexto[1];
        console.log(`Identificado número da nota: ${numeroNota}`);
        
        // Buscar a nota no banco de dados
        const transaction = db.transaction(["notas"], "readonly");
        const store = transaction.objectStore("notas");
        const index = store.index("numero");
        const request = index.get(numeroNota);
        
        request.onsuccess = function(event) {
            const nota = event.target.result;
            if (!nota) {
                console.log(`Nota ${numeroNota} não encontrada no banco de dados`);
                return;
            }
            
            console.log(`Nota encontrada: `, nota);
            
            // Obter a chave de acesso
            const chaveAcesso = nota.chaveAcesso || nota.chave || '-';
            
            // Encontrar o local para inserir a chave
            const infoContainer = modal.querySelector('.modal-body > div:first-child') || 
                                modal.querySelector('.modal-body');
            
            if (infoContainer) {
                // Criar o elemento para a chave
                const divChave = document.createElement('div');
                divChave.className = 'mb-2';
                divChave.innerHTML = `<strong>Chave de Acesso:</strong> ${chaveAcesso}`;
                
                // Encontrar onde inserir (após o número da nota)
                const elementoNumero = Array.from(infoContainer.children).find(el => 
                    el.textContent.includes('Número:')
                );
                
                if (elementoNumero) {
                    infoContainer.insertBefore(divChave, elementoNumero.nextSibling);
                    console.log("Chave de acesso adicionada após o número da nota");
                } else {
                    // Se não encontrar o elemento número, adicionar ao início
                    infoContainer.insertBefore(divChave, infoContainer.firstChild);
                    console.log("Chave de acesso adicionada ao início");
                }
            }
        };
        
        request.onerror = function(event) {
            console.error("Erro ao buscar nota:", event.target.error);
        };
    }

    // Adicionar a chave nas opções de exportação CSV
    function adicionarChaveNasOpcoesExportacao() {
        console.log("Configurando observador para adicionar chave nas opções de exportação...");
        
        // Função para adicionar a opção de chave
        const adicionarOpcaoChave = function() {
            const camposDisponiveis = document.getElementById('camposDisponiveis');
            if (!camposDisponiveis) {
                console.log("Elemento 'camposDisponiveis' não encontrado");
                return;
            }
            
            // Verificar se a opção já existe
            if (camposDisponiveis.querySelector('[data-id="chaveAcesso"]')) {
                console.log("Opção de chave já existe");
                return;
            }
            
            console.log("Adicionando opção de exportação da chave de acesso");
            
            // Criar elemento para a opção
            const itemChave = document.createElement('a');
            itemChave.href = '#';
            itemChave.className = 'list-group-item list-group-item-action';
            itemChave.dataset.id = 'chaveAcesso';
            itemChave.textContent = 'Chave de Acesso da NF';
            
            // Adicionar ao início da lista
            camposDisponiveis.insertBefore(itemChave, camposDisponiveis.firstChild);
            
            // Adicionar evento de clique
            itemChave.addEventListener('click', function() {
                if (typeof toggleSelecaoCampo === 'function') {
                    toggleSelecaoCampo(this);
                } else {
                    this.classList.toggle('active');
                }
            });
            
            console.log("Opção de chave de acesso adicionada com sucesso");
        };
        
        // Observador para detectar quando a lista de campos disponíveis é carregada
        const observer = new MutationObserver(function(mutations) {
            if (document.getElementById('camposDisponiveis')) {
                adicionarOpcaoChave();
                observer.disconnect();
            }
        });
        
        // Iniciar observação
        observer.observe(document.body, { childList: true, subtree: true });
        
        // Também tentar adicionar diretamente caso já exista
        setTimeout(adicionarOpcaoChave, 1000);
        setTimeout(adicionarOpcaoChave, 3000); // Tentar novamente após um tempo maior
    }

    // Inicializar todas as melhorias
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Inicializando melhorias para a chave de NF...");
        setTimeout(function() {
            melhorarExtracaoChaveNF();
            corrigirExibicaoChaveNF();
            adicionarChaveNasOpcoesExportacao();
        }, 500);
    });

    // Solução simplificada para adicionar a chave da NFe
    (function() {
        console.log("Iniciando solução para adicionar chave de acesso da NFe");

        // 1. Adicionar campo de chave na tabela de detalhes (abordagem direta)
        function adicionarChaveNaTabela() {
            // Encontrar a tabela de dados completos
            const tabelas = document.querySelectorAll('table');
            for (const tabela of tabelas) {
                // Verificar se é a tabela de dados completos (tem uma coluna para número da nota)
                const cabecalhos = tabela.querySelectorAll('th');
                let isDataTable = false;
                for (const header of cabecalhos) {
                    if (header.textContent.includes('Número') || header.textContent.includes('Nota')) {
                        isDataTable = true;
                        break;
                    }
                }
                
                if (!isDataTable) continue;
                
                // Verificar se já tem coluna de chave
                let temChave = false;
                for (const header of cabecalhos) {
                    if (header.textContent.includes('Chave')) {
                        temChave = true;
                        break;
                    }
                }
                
                // Adicionar cabeçalho se não existir
                if (!temChave) {
                    const tr = tabela.querySelector('thead tr');
                    if (tr) {
                        const th = document.createElement('th');
                        th.textContent = 'Chave de Acesso da NF';
                        tr.insertBefore(th, tr.firstChild);
                        
                        // Adicionar células vazias para as linhas existentes
                        const rows = tabela.querySelectorAll('tbody tr');
                        for (const row of rows) {
                            const td = document.createElement('td');
                            td.className = 'chave-acesso-cell';
                            row.insertBefore(td, row.firstChild);
                        }
                    }
                }
            }
        }
        
        // 2. Preencher células de chave com os dados reais
        function preencherCelulasChave() {
            // Carregar todas as notas do banco
            const transaction = db.transaction(["notas"], "readonly");
            const store = transaction.objectStore("notas");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const notas = event.target.result;
                
                // Criar um mapa número->chave para uso rápido
                const mapaChaves = {};
                notas.forEach(nota => {
                    if (nota.numero && (nota.chaveAcesso || nota.chave)) {
                        mapaChaves[nota.numero] = nota.chaveAcesso || nota.chave;
                    }
                });
                
                // Tentar extrair chaves se possível
                notas.forEach(nota => {
                    if (!nota.chaveAcesso && !nota.chave && nota.xmlOriginal) {
                        try {
                            // Tentar extrair do XML
                            const match = nota.xmlOriginal.match(/Id=['"]NFe(\d{44})['"]/) || 
                                        nota.xmlOriginal.match(/<chNFe>(\d{44})<\/chNFe>/);
                            
                            if (match && match[1]) {
                                nota.chaveAcesso = match[1];
                                mapaChaves[nota.numero] = match[1];
                                
                                // Atualizar no banco
                                const updateTx = db.transaction(["notas"], "readwrite");
                                const updateStore = updateTx.objectStore("notas");
                                updateStore.put(nota);
                            }
                        } catch(e) {
                            console.warn("Erro ao extrair chave do XML:", e);
                        }
                    }
                });
                
                // Preencher as células da tabela
                const celulas = document.querySelectorAll('.chave-acesso-cell');
                celulas.forEach(celula => {
                    const row = celula.parentElement;
                    const cells = row.querySelectorAll('td');
                    
                    // Encontrar a célula com o número da nota
                    let numeroNota = null;
                    for (let i = 0; i < cells.length; i++) {
                        // Verificar se a célula contém apenas números com possíveis pontuações
                        const content = cells[i].textContent.trim();
                        if (/^\d+$/.test(content.replace(/\D/g, ''))) {
                            numeroNota = content.replace(/\D/g, '');
                            break;
                        }
                    }
                    
                    if (numeroNota && mapaChaves[numeroNota]) {
                        celula.textContent = mapaChaves[numeroNota];
                    }
                });
            };
        }
        
        // 3. Adicionar chave no modal de detalhes
        function adicionarChaveNoModal() {
            // Observar abertura de modais
            document.addEventListener('click', function(e) {
                // Verificar se clicou em algo que abre detalhes
                if (e.target.closest('[data-bs-toggle="modal"]') || 
                    e.target.closest('[data-toggle="modal"]')) {
                    
                    // Esperar o modal abrir
                    setTimeout(function() {
                        const modal = document.querySelector('.modal.show') || 
                                    document.querySelector('[role="dialog"].show');
                        
                        if (!modal) return;
                        
                        // Verificar se já tem chave
                        if (modal.innerHTML.includes('Chave de Acesso')) return;
                        
                        // Extrair número da nota
                        const textoNumero = modal.textContent.match(/Número:[\s]*(\d+)/);
                        if (!textoNumero) return;
                        
                        const numeroNota = textoNumero[1];
                        
                        // Buscar a nota
                        const tx = db.transaction(["notas"], "readonly");
                        const store = tx.objectStore("notas");
                        const request = store.getAll();
                        
                        request.onsuccess = function(event) {
                            const notas = event.target.result;
                            const nota = notas.find(n => n.numero == numeroNota);
                            
                            if (!nota) return;
                            
                            // Criar elemento para a chave
                            const chave = nota.chaveAcesso || nota.chave || '';
                            if (!chave) return;
                            
                            // Encontrar onde inserir
                            const infoDiv = modal.querySelector('.modal-body > div:first-child');
                            if (!infoDiv) return;
                            
                            const div = document.createElement('div');
                            div.innerHTML = `<strong>Chave de Acesso:</strong> ${chave}`;
                            div.className = 'mb-2';
                            
                            // Inserir após o número
                            const divNumero = Array.from(infoDiv.children).find(
                                el => el.textContent.includes('Número:')
                            );
                            
                            if (divNumero) {
                                infoDiv.insertBefore(div, divNumero.nextSibling);
                            } else {
                                infoDiv.appendChild(div);
                            }
                        };
                    }, 300);
                }
            });
        }
        
        // 4. Adicionar chave nas opções de exportação
        function adicionarChaveNaExportacao() {
            // Observar quando a aba de exportação for carregada
            const observer = new MutationObserver(function() {
                const camposDisponiveis = document.getElementById('camposDisponiveis');
                if (!camposDisponiveis) return;
                
                // Verificar se a opção já existe
                if (camposDisponiveis.querySelector('[data-id="chaveAcesso"]')) return;
                
                // Criar a opção
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.dataset.id = 'chaveAcesso';
                item.textContent = 'Chave de Acesso da NF';
                
                // Adicionar no início
                camposDisponiveis.insertBefore(item, camposDisponiveis.firstChild);
                
                // Adicionar evento
                item.addEventListener('click', function() {
                    // Remover active de outros itens
                    const itens = camposDisponiveis.querySelectorAll('.active');
                    itens.forEach(i => i.classList.remove('active'));
                    
                    // Adicionar active neste item
                    this.classList.add('active');
                    
                    // Evento para botão de adicionar
                    const btnAdd = document.getElementById('btnAdicionarCampo');
                    if (btnAdd) {
                        btnAdd.click();
                    }
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }
        
        // Executar as funções com atrasos seguros
        setTimeout(adicionarChaveNaTabela, 800);
        setTimeout(preencherCelulasChave, 1200);
        setTimeout(adicionarChaveNoModal, 500);
        setTimeout(adicionarChaveNaExportacao, 700);
        
        // Verificar periodicamente e tentar novamente se necessário
        const intervalCheck = setInterval(function() {
            // Verificar se ainda precisamos adicionar em algum lugar
            const tabelaSemChave = !document.querySelector('th:contains("Chave")');
            const modalSemChave = document.querySelector('.modal.show') && 
                                !document.querySelector('.modal.show:contains("Chave de Acesso")');
            
            if (tabelaSemChave) {
                adicionarChaveNaTabela();
                preencherCelulasChave();
            }
            
            if (modalSemChave) {
                // Tentar adicionar ao modal aberto atual
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    // (... lógica para adicionar ao modal atual ...)
                }
            }
            
            // Para o intervalo após 30 segundos
            setTimeout(() => clearInterval(intervalCheck), 30000);
        }, 5000);
        
    })();

    // Função para corrigir a exibição da chave de acesso
    function corrigirExibicaoChaveAcesso() {
        console.log("Corrigindo exibição da chave de acesso da NFe");

        // Função especializada para extrair corretamente a chave
        function extrairChave(xml) {
            if (!xml) return null;
            
            try {
                // Padrões de busca para a chave (sempre como string)
                const padroes = [
                    /Id=['"]NFe(\d{44})['"]/, 
                    /<chNFe>(\d{44})<\/chNFe>/,
                    /<cUF>(\d{2})<\/cUF>.*?<dhEmi>(.*?)<\/dhEmi>.*?<cNF>(\d{8})<\/cNF>.*?<serie>(\d{1,3})<\/serie>/
                ];
                
                // Tentar cada padrão
                for (const padrao of padroes) {
                    const match = xml.match(padrao);
                    if (match && match[1]) {
                        // Garantir que é tratado como string, não como número
                        return String(match[1]);
                    }
                }
                
                return null;
            } catch (e) {
                console.error("Erro ao extrair chave:", e);
                return null;
            }
        }
        
        // 1. Atualizar o banco de dados com as chaves corretas (como strings)
        function atualizarChavesNoBanco() {
            const transaction = db.transaction(["notas"], "readwrite");
            const store = transaction.objectStore("notas");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const notas = event.target.result;
                let notasAtualizadas = 0;
                
                notas.forEach(nota => {
                    // Verificar se a chave parece estar em notação científica ou está ausente
                    const chaveAtual = nota.chaveAcesso || nota.chave;
                    const precisaAtualizar = !chaveAtual || 
                                            chaveAtual.includes('e+') || 
                                            chaveAtual.length !== 44;
                    
                    if (precisaAtualizar && nota.xmlOriginal) {
                        const chaveExtraida = extrairChave(nota.xmlOriginal);
                        
                        if (chaveExtraida && chaveExtraida.length === 44) {
                            nota.chaveAcesso = chaveExtraida; // Guardar como string
                            notasAtualizadas++;
                            store.put(nota);
                        }
                    }
                });
                
                console.log(`Atualizadas ${notasAtualizadas} notas com chaves corrigidas`);
                
                // Após atualizar o banco, atualizar a exibição
                if (notasAtualizadas > 0) {
                    setTimeout(atualizarExibicaoChaves, 500);
                }
            };
        }
        
        // 2. Atualizar a exibição das chaves na tabela e modais
        function atualizarExibicaoChaves() {
            // 2.1 Tabela principal
            const celulasChave = document.querySelectorAll('.chave-acesso-cell, td:first-child');
            
            if (celulasChave.length > 0) {
                const transaction = db.transaction(["notas"], "readonly");
                const store = transaction.objectStore("notas");
                const request = store.getAll();
                
                request.onsuccess = function(event) {
                    const notas = event.target.result;
                    const mapaChaves = {};
                    
                    // Criar mapa de número da nota para chave
                    notas.forEach(nota => {
                        if (nota.numero && (nota.chaveAcesso || nota.chave)) {
                            mapaChaves[nota.numero] = String(nota.chaveAcesso || nota.chave);
                        }
                    });
                    
                    // Atualizar células
                    celulasChave.forEach(celula => {
                        const row = celula.parentElement;
                        const cellsRow = row.querySelectorAll('td');
                        
                        // Procurar o número da nota nesta linha
                        let numeroNota = null;
                        for (let i = 0; i < cellsRow.length; i++) {
                            const cellText = cellsRow[i].textContent.trim();
                            // Procurar uma célula que tenha apenas dígitos (possivelmente o número da nota)
                            if (/^\d+$/.test(cellText.replace(/\D/g, ''))) {
                                numeroNota = cellText.replace(/\D/g, '');
                                break;
                            }
                        }
                        
                        // Se encontramos um número e temos a chave, atualizar
                        if (numeroNota && mapaChaves[numeroNota]) {
                            celula.textContent = mapaChaves[numeroNota];
                        }
                    });
                };
            }
            
            // 2.2 Modal de detalhes (se estiver aberto)
            const modal = document.querySelector('.modal.show');
            if (modal) {
                // Extrair número da nota do modal
                const textoNumero = modal.textContent.match(/Número:[\s]*(\d+)/);
                if (textoNumero && textoNumero[1]) {
                    const numeroNota = textoNumero[1];
                    
                    // Buscar a nota
                    const transaction = db.transaction(["notas"], "readonly");
                    const store = transaction.objectStore("notas");
                    const request = store.getAll();
                    
                    request.onsuccess = function(event) {
                        const notas = event.target.result;
                        const nota = notas.find(n => String(n.numero) === numeroNota);
                        
                        if (nota && (nota.chaveAcesso || nota.chave)) {
                            // Verificar se já existe o elemento da chave
                            let divChave = Array.from(modal.querySelectorAll('div')).find(
                                div => div.textContent.includes('Chave de Acesso:')
                            );
                            
                            if (divChave) {
                                // Atualizar o texto
                                divChave.innerHTML = `<strong>Chave de Acesso:</strong> ${nota.chaveAcesso || nota.chave}`;
                            } else {
                                // Criar novo elemento
                                const infoDiv = modal.querySelector('.modal-body > div:first-child');
                                if (infoDiv) {
                                    divChave = document.createElement('div');
                                    divChave.className = 'mb-2';
                                    divChave.innerHTML = `<strong>Chave de Acesso:</strong> ${nota.chaveAcesso || nota.chave}`;
                                    
                                    // Inserir após o número
                                    const divNumero = Array.from(infoDiv.children).find(
                                        el => el.textContent.includes('Número:')
                                    );
                                    
                                    if (divNumero) {
                                        infoDiv.insertBefore(divChave, divNumero.nextSibling);
                                    } else {
                                        infoDiv.appendChild(divChave);
                                    }
                                }
                            }
                        }
                    };
                }
            }
        }
        
        // Executar as funções
        atualizarChavesNoBanco();
        
        // Verificar periodicamente e atualizar a exibição quando necessário
        const intervalCheck = setInterval(function() {
            atualizarExibicaoChaves();
            
            // Parar após 30 segundos
            setTimeout(() => clearInterval(intervalCheck), 30000);
        }, 5000);
    }

    // Chamar a função quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(corrigirExibicaoChaveAcesso, 1000);
    });

    // Função para corrigir a exportação de chaves de acesso no CSV
    function corrigirExportacaoChaveCSV() {
        console.log("Configurando correção para exportação da chave de acesso no CSV");
        
        // Interceptar a função de exportação CSV
        const verificarECorrigirExportacao = function() {
            // Encontrar a função de exportar CSV
            if (typeof window.exportarCSV === 'function') {
                console.log("Função exportarCSV encontrada, aplicando correção");
                
                // Guardar a função original
                const exportarCSVOriginal = window.exportarCSV;
                
                // Sobrescrever com a versão corrigida
                window.exportarCSV = function() {
                    console.log("Executando exportarCSV com correção para chave de acesso");
                    
                    // Obter os campos selecionados antes de chamar a função original
                    const camposSelecionados = document.getElementById('camposSelecionados');
                    const temChaveAcesso = camposSelecionados && 
                        Array.from(camposSelecionados.querySelectorAll('.list-group-item'))
                            .some(item => item.dataset.id === 'chaveAcesso');
                    
                    if (!temChaveAcesso) {
                        // Se não há chave de acesso nos campos selecionados, usar função original
                        return exportarCSVOriginal.apply(this, arguments);
                    }
                    
                    // Implementar nossa própria versão da exportação com tratamento especial para a chave
                    const campos = camposSelecionados.querySelectorAll('.list-group-item');
                    
                    if (campos.length === 0) {
                        alert('Selecione pelo menos um campo para exportar');
                        return;
                    }
                    
                    // Obter todos os campos selecionados
                    const camposParaExportar = [];
                    campos.forEach(campo => {
                        camposParaExportar.push({
                            id: campo.dataset.id,
                            nome: campo.textContent
                        });
                    });
                    
                    // Obter dados do banco de dados
                    const transaction = db.transaction(["notas"], "readonly");
                    const store = transaction.objectStore("notas");
                    const request = store.getAll();
                    
                    request.onsuccess = function(event) {
                        const notas = event.target.result;
                        
                        if (notas.length === 0) {
                            alert('Não há dados para exportar');
                            return;
                        }
                        
                        // Criar CSV
                        let csv = '';
                        
                        // Adicionar cabeçalhos se solicitado
                        const incluirCabecalhos = document.getElementById('incluirCabecalhos')?.checked ?? true;
                        if (incluirCabecalhos) {
                            csv += camposParaExportar.map(campo => `"${campo.nome}"`).join(',') + '\n';
                        }
                        
                        // Adicionar dados com tratamento especial para a chave de acesso
                        notas.forEach(nota => {
                            const linha = camposParaExportar.map(campo => {
                                // Lidar com campos aninhados (como emitente.nome)
                                const partes = campo.id.split('.');
                                let valor = nota;
                                
                                for (const parte of partes) {
                                    if (valor && valor[parte] !== undefined) {
                                        valor = valor[parte];
                                    } else {
                                        valor = '';
                                        break;
                                    }
                                }
                                
                                // Tratamento especial para a chave de acesso - garantir que seja string
                                if (campo.id === 'chaveAcesso' && valor) {
                                    // Forçar como string para evitar notação científica
                                    return `="${String(valor)}"`;  // Formato especial para Excel tratar como texto
                                }
                                
                                // Formatar o valor para CSV
                                if (valor === null || valor === undefined) valor = '';
                                return `"${String(valor).replace(/"/g, '""')}"`;
                            });
                            
                            csv += linha.join(',') + '\n';
                        });
                        
                        // Criar blob e download
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const dataAtual = new Date().toLocaleDateString().replace(/\//g, '-');
                        const nomeArquivo = `exportacao_notas_${dataAtual}.csv`;
                        
                        // Criar link para download
                        const link = document.createElement('a');
                        if (link.download !== undefined) {
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', nomeArquivo);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } else {
                            alert('Seu navegador não suporta download automático. O CSV foi gerado, mas você precisa salvá-lo manualmente.');
                            console.log(csv);
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error("Erro ao buscar dados para exportação:", event.target.error);
                        alert("Ocorreu um erro ao buscar os dados para exportação.");
                    };
                };
                
                console.log("Correção para exportação CSV aplicada");
                return true;
            }
            return false;
        };
        
        // Tentar aplicar a correção imediatamente
        if (!verificarECorrigirExportacao()) {
            // Se não encontrou a função, configurar um observador para tentar novamente
            console.log("Função exportarCSV não encontrada, configurando observador");
            
            // Usar MutationObserver para detectar quando elementos relacionados à exportação são adicionados
            const observer = new MutationObserver(function() {
                if (document.getElementById('exportacao') || document.getElementById('btnExportarCSV')) {
                    if (verificarECorrigirExportacao()) {
                        observer.disconnect();
                        console.log("Observador para corrigir exportação desconectado após sucesso");
                    }
                }
            });
            
            // Iniciar observação
            observer.observe(document.body, { childList: true, subtree: true });
            
            // Tentar novamente após alguns segundos, em caso de falha
            setTimeout(verificarECorrigirExportacao, 3000);
            setTimeout(verificarECorrigirExportacao, 6000);
        }
    }

    // Chamar a função quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(corrigirExportacaoChaveCSV, 1500);
    });

    // Função para substituir os painéis existentes por visualizações mais úteis
    function melhorarDashboard() {
        console.log("Melhorando o dashboard com visualizações mais relevantes");
        
        // Função para encontrar os painéis a serem substituídos
        function substituirPaineis() {
            // Procurar cards existentes
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                const header = card.querySelector('.card-header');
                if (!header) return;
                
                // Verificar o título do card
                const titulo = header.textContent.trim();
                
                if (titulo === 'Total por Tipo de Nota') {
                    console.log("Substituindo painel 'Total por Tipo de Nota'");
                    substituirPorEvolucaoMensal(card);
                } 
                else if (titulo === 'Total por Destinatário (Top 5)') {
                    console.log("Substituindo painel 'Total por Destinatário (Top 5)'");
                    substituirPorComparativoImpostos(card);
                }
            });
        }
        
        // Substituir por evolução mensal de valores
        function substituirPorEvolucaoMensal(card) {
            // Atualizar o título
            const header = card.querySelector('.card-header');
            if (header) {
                header.innerHTML = '<i class="fas fa-chart-line mr-2"></i> Evolução Mensal de Valores';
            }
            
            // Limpar o conteúdo atual
            const body = card.querySelector('.card-body');
            if (body) {
                body.innerHTML = '<canvas id="evolucaoMensalChart" style="height: 300px; width: 100%;"></canvas>';
                
                // Carregar dados para o gráfico
                setTimeout(() => {
                    carregarDadosEvolucaoMensal();
                }, 500);
            }
        }
        
        // Substituir por comparativo de impostos
        function substituirPorComparativoImpostos(card) {
            // Atualizar o título
            const header = card.querySelector('.card-header');
            if (header) {
                header.innerHTML = '<i class="fas fa-balance-scale mr-2"></i> Comparativo de Impostos por CFOP';
            }
            
            // Limpar o conteúdo atual
            const body = card.querySelector('.card-body');
            if (body) {
                body.innerHTML = `
                    <div class="form-group">
                        <select id="seletorCfop" class="form-control mb-3">
                            <option value="todos">Todos os CFOPs</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="tabelaComparativoImpostos">
                            <thead>
                                <tr>
                                    <th>CFOP</th>
                                    <th>Descrição</th>
                                    <th>Valor Total</th>
                                    <th>ICMS</th>
                                    <th>IPI</th>
                                    <th>PIS</th>
                                    <th>COFINS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Carregar dados para a tabela
                setTimeout(() => {
                    carregarDadosComparativoImpostos();
                }, 500);
            }
        }
        
        // Função para carregar dados de evolução mensal
        function carregarDadosEvolucaoMensal() {
            const transaction = db.transaction(["notas"], "readonly");
            const store = transaction.objectStore("notas");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const notas = event.target.result;
                
                // Agrupar notas por mês
                const dadosPorMes = {};
                
                notas.forEach(nota => {
                    if (!nota.data) return;
                    
                    // Extrair mês e ano
                    const data = new Date(nota.data);
                    if (isNaN(data.getTime())) {
                        // Tentar formato DD/MM/YYYY
                        const partes = nota.data.split('/');
                        if (partes.length === 3) {
                            data.setFullYear(parseInt(partes[2]), parseInt(partes[1]) - 1, parseInt(partes[0]));
                        } else {
                            return; // Data inválida
                        }
                    }
                    
                    const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
                    
                    if (!dadosPorMes[mesAno]) {
                        dadosPorMes[mesAno] = {
                            total: 0,
                            impostos: 0
                        };
                    }
                    
                    // Somar valores
                    dadosPorMes[mesAno].total += parseFloat(nota.valorTotal || 0);
                    
                    // Somar impostos (se disponíveis)
                    const impostos = (nota.impostosTotais || {});
                    dadosPorMes[mesAno].impostos += 
                        parseFloat(impostos.valorICMS || 0) + 
                        parseFloat(impostos.valorIPI || 0) + 
                        parseFloat(impostos.valorPIS || 0) + 
                        parseFloat(impostos.valorCOFINS || 0);
                });
                
                // Ordenar meses cronologicamente
                const mesesOrdenados = Object.keys(dadosPorMes).sort((a, b) => {
                    const [mesA, anoA] = a.split('/');
                    const [mesB, anoB] = b.split('/');
                    
                    if (anoA !== anoB) {
                        return parseInt(anoA) - parseInt(anoB);
                    }
                    
                    return parseInt(mesA) - parseInt(mesB);
                });
                
                // Preparar dados para o gráfico
                const labels = mesesOrdenados;
                const valoresTotal = mesesOrdenados.map(mes => dadosPorMes[mes].total);
                const valoresImpostos = mesesOrdenados.map(mes => dadosPorMes[mes].impostos);
                
                // Criar gráfico
                const ctx = document.getElementById('evolucaoMensalChart').getContext('2d');
                
                if (window.evolucaoMensalChart instanceof Chart) {
                    window.evolucaoMensalChart.destroy();
                }
                
                window.evolucaoMensalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Valor Total',
                                data: valoresTotal,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                fill: true
                            },
                            {
                                label: 'Total de Impostos',
                                data: valoresImpostos,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': R$ ' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            };
        }
        
        // Função para carregar dados comparativos de impostos
        function carregarDadosComparativoImpostos() {
            const transaction = db.transaction(["notas"], "readonly");
            const store = transaction.objectStore("notas");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const notas = event.target.result;
                
                // Mapear CFOPs para suas descrições
                const cfopDescricoes = {
                    "5102": "Venda de mercadoria",
                    "5405": "Venda de mercadoria adquirida/recebida de terceiros",
                    "5910": "Remessa em bonificação, doação ou brinde",
                    "5949": "Outra saída de mercadoria ou prestação de serviço",
                    "6102": "Venda de mercadoria para outro estado",
                    "6108": "Venda de mercadoria para exportação",
                    "1102": "Compra de mercadoria",
                    "1949": "Outra entrada de mercadoria ou aquisição de serviço",
                    "2102": "Compra de mercadoria de outro estado"
                    // Adicionar mais conforme necessário
                };
                
                // Agrupar por CFOP
                const dadosPorCFOP = {};
                
                notas.forEach(nota => {
                    if (!nota.cfop) return;
                    
                    const cfop = nota.cfop;
                    
                    if (!dadosPorCFOP[cfop]) {
                        dadosPorCFOP[cfop] = {
                            descricao: cfopDescricoes[cfop] || "CFOP " + cfop,
                            valorTotal: 0,
                            icms: 0,
                            ipi: 0,
                            pis: 0,
                            cofins: 0,
                            count: 0
                        };
                    }
                    
                    // Somar valores
                    dadosPorCFOP[cfop].valorTotal += parseFloat(nota.valorTotal || 0);
                    dadosPorCFOP[cfop].count++;
                    
                    // Somar impostos (se disponíveis)
                    const impostos = (nota.impostosTotais || {});
                    dadosPorCFOP[cfop].icms += parseFloat(impostos.valorICMS || 0);
                    dadosPorCFOP[cfop].ipi += parseFloat(impostos.valorIPI || 0);
                    dadosPorCFOP[cfop].pis += parseFloat(impostos.valorPIS || 0);
                    dadosPorCFOP[cfop].cofins += parseFloat(impostos.valorCOFINS || 0);
                });
                
                // Preencher o seletor de CFOP
                const seletor = document.getElementById('seletorCfop');
                if (seletor) {
                    // Manter a opção "Todos os CFOPs"
                    let html = '<option value="todos">Todos os CFOPs</option>';
                    
                    // Adicionar opções para cada CFOP
                    Object.keys(dadosPorCFOP).sort().forEach(cfop => {
                        html += `<option value="${cfop}">${cfop} - ${dadosPorCFOP[cfop].descricao}</option>`;
                    });
                    
                    seletor.innerHTML = html;
                    
                    // Adicionar evento de mudança
                    seletor.addEventListener('change', function() {
                        atualizarTabelaComparativo(dadosPorCFOP, this.value);
                    });
                }
                
                // Preencher a tabela inicialmente com todos os CFOPs
                atualizarTabelaComparativo(dadosPorCFOP, 'todos');
            };
        }
        
        // Função para atualizar a tabela de comparativo
        function atualizarTabelaComparativo(dadosPorCFOP, cfopSelecionado) {
            const tabela = document.getElementById('tabelaComparativoImpostos');
            if (!tabela) return;
            
            const tbody = tabela.querySelector('tbody');
            
            // Formatar valor para exibição
            const formatarValor = (valor) => {
                return 'R$ ' + parseFloat(valor || 0).toFixed(2);
            };
            
            // Construir linhas da tabela
            let html = '';
            
            if (cfopSelecionado === 'todos') {
                // Mostrar todos os CFOPs
                Object.entries(dadosPorCFOP)
                    .sort((a, b) => b[1].valorTotal - a[1].valorTotal) // Ordenar por valor total
                    .forEach(([cfop, dados]) => {
                        html += `
                            <tr>
                                <td>${cfop}</td>
                                <td>${dados.descricao}</td>
                                <td>${formatarValor(dados.valorTotal)}</td>
                                <td>${formatarValor(dados.icms)}</td>
                                <td>${formatarValor(dados.ipi)}</td>
                                <td>${formatarValor(dados.pis)}</td>
                                <td>${formatarValor(dados.cofins)}</td>
                            </tr>
                        `;
                    });
            } else {
                // Mostrar apenas o CFOP selecionado com detalhamento
                const dados = dadosPorCFOP[cfopSelecionado];
                
                if (dados) {
                    // Mostrar linha do CFOP
                    html += `
                        <tr class="table-primary">
                            <td>${cfopSelecionado}</td>
                            <td>${dados.descricao}</td>
                            <td>${formatarValor(dados.valorTotal)}</td>
                            <td>${formatarValor(dados.icms)}</td>
                            <td>${formatarValor(dados.ipi)}</td>
                            <td>${formatarValor(dados.pis)}</td>
                            <td>${formatarValor(dados.cofins)}</td>
                        </tr>
                    `;
                    
                    // Adicionar detalhamento - resumo de alíquotas
                    const aliquotaICMS = (dados.valorTotal > 0) ? (dados.icms / dados.valorTotal * 100) : 0;
                    const aliquotaIPI = (dados.valorTotal > 0) ? (dados.ipi / dados.valorTotal * 100) : 0;
                    const aliquotaPIS = (dados.valorTotal > 0) ? (dados.pis / dados.valorTotal * 100) : 0;
                    const aliquotaCOFINS = (dados.valorTotal > 0) ? (dados.cofins / dados.valorTotal * 100) : 0;
                    
                    html += `
                        <tr class="table-light">
                            <td colspan="2" class="text-right"><strong>Alíquota Média:</strong></td>
                            <td>-</td>
                            <td>${aliquotaICMS.toFixed(2)}%</td>
                            <td>${aliquotaIPI.toFixed(2)}%</td>
                            <td>${aliquotaPIS.toFixed(2)}%</td>
                            <td>${aliquotaCOFINS.toFixed(2)}%</td>
                        </tr>
                        <tr class="table-light">
                            <td colspan="2" class="text-right"><strong>Quantidade de Notas:</strong></td>
                            <td colspan="5">${dados.count} nota(s)</td>
                        </tr>
                    `;
                } else {
                    html = '<tr><td colspan="7" class="text-center">CFOP não encontrado</td></tr>';
                }
            }
            
            if (html === '') {
                html = '<tr><td colspan="7" class="text-center">Nenhum dado disponível</td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        // Iniciar a substituição após um tempo para garantir que a página esteja carregada
        setTimeout(substituirPaineis, 1000);
        
        // Adicionar FontAwesome se ainda não foi adicionado
        if (!document.querySelector('link[href*="font-awesome"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
            document.head.appendChild(link);
        }
    }

    // Chamar a função quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(melhorarDashboard, 800);
    });
</script>

</html>